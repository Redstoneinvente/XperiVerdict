<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Xperia Cloud Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Google+Sans+Text:wght@400;500&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
    <style>
        :root {
            --m3-p: #6750a4; 
            --m3-on-p: #ffffff;
            --m3-p-c: #eaddff;
            --m3-on-p-c: #21005d;
            --m3-surf: #f6f2f7; 
            --m3-surf-elevated: #ffffff;
            --m3-out: #79747e;
            --m3-out-var: #c4c7c5;
            --ease-emphasized: cubic-bezier(0.3, 0, 0, 1);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --glass: blur(20px) saturate(180%);
        }

        .profile-circle { 
            width: 40px; 
            height: 40px; 
            background: var(--m3-p-c); /* Light Purple */
            border-radius: 50%; 
            display: grid; 
            place-items: center; 
            cursor: pointer; 
            font-weight: bold; 
            color: var(--m3-p); /* Dark Purple Text */
            text-transform: uppercase;
            flex-shrink: 0; /* Prevents it from being crushed if title is long */
        }

        body { 
            background: var(--m3-surf); 
            font-family: 'Google Sans Text', sans-serif; 
            margin: 0; color: #1d1b20; 
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
        }

        /* Dropdown Menu Container */
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 70px; /* Positioned below the top bar */
            right: 20px;
            width: 240px;
            background: var(--m3-surf-elevated);
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
            transform-origin: top right;
            animation: menuIn 0.2s var(--ease-emphasized);
        }

        @keyframes menuIn {
            from { opacity: 0; transform: scale(0.9) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Dropdown Items */
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s;
            color: #1d1b20;
            font-size: 0.95rem;
        }

        .menu-item:hover { background: rgba(0,0,0,0.04); }

        .menu-item .material-symbols-rounded { color: var(--m3-p); }

        .menu-divider { height: 1px; background: var(--m3-out-var); opacity: 0.3; margin: 4px 0; }

        .modal-overlay { 
            display: none; /* Controlled by JS */
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            display: none; /* We override this to 'flex' in JS */
            align-items: center; 
            justify-content: center; 
        }

        /* Profile UI Additions */
        .profile-comp-container { text-align: center; }
        .avatar-wrapper { position: relative; width: 84px; height: 84px; margin: 0 auto 16px; }
        .avatar-main { 
            width: 100%; height: 100%; background: var(--m3-p); color: white; 
            border-radius: 50%; display: grid; place-items: center; 
            font-size: 2.2rem; font-weight: 500; box-shadow: 0 4px 12px rgba(103, 80, 164, 0.2); 
        }
        .avatar-edit-badge { 
            position: absolute; bottom: 0; right: 0; background: white; 
            border-radius: 50%; width: 28px; height: 28px; display: grid; 
            place-items: center; border: 1px solid var(--m3-out-var); box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page { 
            position: fixed; inset: 0; padding: 0 20px 40px 20px; 
            transition: transform 0.5s var(--ease-emphasized), opacity 0.4s ease;
            overflow-y: auto; background: var(--m3-surf); z-index: 10;
        }
        .page-hidden { transform: scale(0.96) translateY(20px); opacity: 0; pointer-events: none; }

        .top-app-bar { 
            display: flex; 
            flex-direction: row;      /* Ensure horizontal flow */
            align-items: center;      /* Vertically center items */
            justify-content: space-between; /* Pushes Title to Left, Profile to Right */
            padding: 12px 20px; 
            position: sticky; 
            top: 0; 
            background: rgba(246, 242, 247, 0.8); 
            backdrop-filter: var(--glass); 
            -webkit-backdrop-filter: var(--glass); 
            z-index: 100; 
            margin: 0;                /* Remove negative margins if they exist */
            box-sizing: border-box;   /* Ensures padding doesn't break width */
            width: 100%;
        }

        .m3-card {
            background: var(--m3-surf-elevated);
            border-radius: 28px; padding: 20px; margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }
        .m3-card:active { transform: scale(0.98); }

        .search-container {
            background: white; border-radius: 16px; padding: 4px 16px;
            display: flex; align-items: center; gap: 12px; margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .search-container input { border: none; background: transparent; outline: none; height: 48px; width: 100%; font-family: inherit; font-size: 1rem; }

        .chip-row { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0 20px; scrollbar-width: none; }
        .chip {
            padding: 10px 20px; border-radius: 12px; background: white;
            font-size: 0.85rem; font-weight: 500; color: var(--m3-out);
            border: 1px solid var(--m3-out-var); cursor: pointer; flex-shrink: 0;
        }
        .chip.active { background: var(--m3-on-p-c); color: white; border-color: var(--m3-on-p-c); }

        .m3-btn {
            background: var(--m3-p); color: white; border: none;
            padding: 14px 28px; border-radius: 16px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 8px; cursor: pointer; width: 100%; justify-content: center;
        }

        .rating-badge { background: var(--m3-p-c); color: var(--m3-on-p-c); padding: 12px 20px; border-radius: 20px; text-align: center; }
        .stat-box { padding: 16px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.05); }
        .label-meta { color: var(--m3-out); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        
        .star-input span { font-size: 38px; color: var(--m3-out-var); cursor: pointer; }
        .star-input span.active { color: #FFB300; font-variation-settings: 'FILL' 1; }

        .legal-footer { padding: 32px 20px 60px 20px; text-align: center; border-top: 1px solid rgba(0,0,0,0.05); margin-top: 20px; }
        .legal-text { font-size: 0.7rem; color: var(--m3-out); line-height: 1.5; }
    </style>
</head>
<body>
    <div id="pageLogin" class="page">
        <div style="height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
            <div style="width: 80px; height: 80px; background: var(--m3-p-c); border-radius: 24px; display: grid; place-items: center; margin-bottom: 24px;">
                <span class="material-symbols-rounded" style="font-size: 40px; color: var(--m3-p);">lock</span>
            </div>
            <h1 style="margin-bottom: 8px;">Xperia Cloud</h1>
            <p style="color: var(--m3-out); margin-bottom: 32px;">Community Intelligence Portal</p>
            
            <div class="m3-card" style="width: 100%; box-sizing: border-box;">
                <input type="email" id="loginEmail" placeholder="Email" style="width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--m3-out-var); margin-bottom: 12px; box-sizing: border-box;">
                <input type="password" id="loginPass" placeholder="Password" style="width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--m3-out-var); margin-bottom: 20px; box-sizing: border-box;">
                <button class="m3-btn" id="btnLogin">Sign In</button>
            </div>
        </div>
    </div>

    <div id="pageDevices" class="page">
        <div class="top-app-bar">
            <h1>Xperia Cloud</h1>
            <div class="profile-circle" id="profileBtn" onclick="toggleModal(document.getElementById('profileDropdown').style.display !== 'block')">?</div>
        </div>
        <p style="color: var(--m3-out); margin-top: -8px; margin-bottom: 24px;">Community Firmware Intelligence</p>
        <div id="deviceList"></div>
    </div>

    <div id="pageVariants" class="page page-hidden">
        <div class="top-app-bar">
            <button style="background:none;border:none;" onclick="nav('pageDevices')"><span class="material-symbols-rounded">arrow_back_ios_new</span></button>
            <h1 id="variantTitle">Models</h1>
        </div>
        <div id="variantList"></div>
    </div>

    <div id="pageFirmwares" class="page page-hidden">
        <div class="top-app-bar">
            <button style="background:none;border:none;" onclick="nav('pageVariants')"><span class="material-symbols-rounded">arrow_back_ios_new</span></button>
            <div style="flex:1"><h1 id="modelCodeHeader" style="font-size: 1.2rem;">Model</h1></div>
        </div>
        
        <div class="m3-card" style="background: var(--m3-p-c); border: none; margin-bottom: 24px;">
            <div class="label-meta" style="color: var(--m3-on-p-c); opacity: 0.7;">Selected Device</div>
            <h2 id="currentDeviceName" style="margin: 4px 0; color: var(--m3-on-p-c);">Device</h2>
            <p id="currentDeviceDesc" style="margin: 0; font-size: 0.9rem; color: var(--m3-on-p-c); opacity: 0.8;"></p>
        </div>

        <div class="search-container">
            <span class="material-symbols-rounded">search</span>
            <input type="text" placeholder="Filter version..." id="fwSearchInput">
        </div>

        <div class="chip-row">
            <div class="chip active" onclick="setFilter('all', this)">All Feeds</div>
            <div class="chip" onclick="setFilter('Security', this)">Security Patches</div>
            <div class="chip" onclick="setFilter('Android', this)">OS Upgrades</div>
        </div>
        <div id="fwList"></div>
    </div>

    <div id="pageDetail" class="page page-hidden">
        <div class="top-app-bar">
            <button style="background:none;border:none;" onclick="nav('pageFirmwares')"><span class="material-symbols-rounded">expand_more</span></button>
            <h1 style="font-size: 1.1rem; flex:1; text-align: center;">Firmware Intelligence</h1>
        </div>
        
        <div class="m3-card" style="background: var(--m3-on-p-c); color: white; border: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div class="label-meta" style="color: rgba(255,255,255,0.6);">Current Version</div>
                    <h2 id="detVer" style="margin:4px 0 0 0; font-size: 1.8rem;">0.0.0</h2>
                </div>
                <div class="rating-badge">
                    <div id="avgRatingScore" style="font-size: 2rem; font-weight: 700;">0.0</div>
                    <div style="font-size: 0.6rem; font-weight: 800;">INDEX</div>
                </div>
            </div>
            <p id="detMeta" style="margin: 16px 0 0 0; font-size: 0.85rem; opacity: 0.7;"></p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div class="stat-box" style="background: #fff5f5; border-color: #ffcccc;">
                <h4 style="margin:0 0 8px 0; color: #c30000; font-size: 0.7rem; text-transform: uppercase;">Top Issue</h4>
                <div id="bugContainer" style="font-size: 0.85rem;">-</div>
            </div>
            <div class="stat-box" style="background: #f5fff5; border-color: #ccffcc;">
                <h4 style="margin:0 0 8px 0; color: #008100; font-size: 0.7rem; text-transform: uppercase;">Top Pro</h4>
                <div id="improvementContainer" style="font-size: 0.85rem;">-</div>
            </div>
        </div>

        <div class="m3-card">
            <h3 style="margin: 0 0 12px 0; font-size: 1rem;">Official Changelog</h3>
            <p id="detChangelog" style="margin:0; font-size: 0.9rem; line-height: 1.6; color: var(--m3-out);"></p>
        </div>

        <div class="m3-card" style="text-align: center;">
            <div class="label-meta">Community Stability Vote</div>
            <div class="star-input" id="starSelector" style="display: flex; justify-content: center; gap: 4px; margin: 12px 0;">
                <span class="material-symbols-rounded" data-v="1">star</span>
                <span class="material-symbols-rounded" data-v="2">star</span>
                <span class="material-symbols-rounded" data-v="3">star</span>
                <span class="material-symbols-rounded" data-v="4">star</span>
                <span class="material-symbols-rounded" data-v="5">star</span>
            </div>
            <button class="m3-btn" onclick="submitStarOnly()">Cast Stability Vote</button>
        </div>

        <div class="m3-card">
            <div class="label-meta">Submit Intel</div>
            <select id="contributionType" style="width: 100%; padding: 12px; border-radius: 12px; margin-top: 8px;">
                <option value="improvement">Stable Performance</option>
                <option value="bug">Bug Encountered</option>
            </select>
            <textarea id="contributionText" style="width: 100%; height: 80px; padding: 12px; border-radius: 12px; margin: 12px 0; box-sizing: border-box;" placeholder="Add details..."></textarea>
            <button class="m3-btn" style="background: #1d1b20;" onclick="submitTextReport()">Submit Report</button>
        </div>
    </div>

    <div id="profileDropdown" class="profile-dropdown">
        <div style="padding: 20px; background: var(--m3-p-c); display: flex; align-items: center; gap: 12px;">
            <div id="compAvatar" style="width: 40px; height: 40px; background: var(--m3-p); color: white; border-radius: 50%; display: grid; place-items: center; font-weight: bold;">U</div>
            <div style="overflow: hidden;">
                <div id="compUserName" style="font-weight: 700; font-size: 0.9rem; white-space: nowrap; text-overflow: ellipsis;">User</div>
                <div id="compUserEmail" style="font-size: 0.75rem; color: var(--m3-on-p-c); opacity: 0.7; white-space: nowrap; text-overflow: ellipsis;">email@example.com</div>
            </div>
        </div>

        <div class="menu-divider"></div>

        <div class="menu-item" onclick="alert('Settings')">
            <span class="material-symbols-rounded">settings</span>
            <span>Settings</span>
        </div>
        
        <div class="menu-item" style="color: #ba1a1a;" onclick="handleLogout()">
            <span class="material-symbols-rounded">logout</span>
            <span>Sign Out</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0q57Bv_I4uuRn7cig64DPKa2oviyGHdw",
            authDomain: "xperia-tracker.firebaseapp.com",
            databaseURL: "https://xperia-tracker-default-rtdb.firebaseio.com",
            projectId: "xperia-tracker",
            appId: "1:1028462018440:web:54a8a9d6ae759f2644043d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let state = { devices: [], currentDeviceIdx: null, currentVariantIdx: null, currentFwId: null, filter: 'all', searchQuery: '', userRating: 0 };

        // --- AUTH LOGIC ---
        const loginBtn = document.getElementById('btnLogin');
        if(loginBtn) {
            loginBtn.onclick = () => {
                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;
                signInWithEmailAndPassword(auth, email, pass).catch(err => alert("Auth Failed: " + err.message));
            };
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                // Get the first letter of the email
                const initial = user.email ? user.email[0].toUpperCase() : 'U';
                
                // Find the button in the Top App Bar
                const profileBtn = document.getElementById('profileBtn');
                if (profileBtn) {
                    profileBtn.innerText = initial;
                    profileBtn.style.display = 'grid'; // Force it to show
                }

                // Also update the large avatar inside the modal
                const compAvatar = document.getElementById('compAvatar');
                if (compAvatar) compAvatar.innerText = initial;

                nav('pageDevices');
                loadData();
            } else {
                nav('pageLogin');
            }
        });

        window.logout = () => signOut(auth);

        window.toggleModal = (show) => {
            const menu = document.getElementById('profileDropdown');
            if (menu) {
                menu.style.display = show ? 'block' : 'none';
            }
        };

        // Close dropdown if user clicks anywhere else on the screen
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('profileDropdown');
            const btn = document.getElementById('profileBtn');
            if (menu && menu.style.display === 'block') {
                if (!menu.contains(e.target) && !btn.contains(e.target)) {
                    toggleModal(false);
                }
            }
        });

        // --- NAVIGATION ---
        window.nav = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.add('page-hidden'));
            document.getElementById(id).classList.remove('page-hidden');
        };

        // --- DATA LOADING ---
        function loadData() {
            onValue(ref(db, 'devices'), snap => {
                state.devices = snap.val() || [];
                renderTier1();
            });
        }

        // 1. MAIN LIST (WITH DESCRIPTION)
        function renderTier1() {
            document.getElementById('deviceList').innerHTML = state.devices.map((d, i) => `
                <div class="m3-card" onclick="selectDevice(${i})">
                    <div style="display:flex; align-items:center; gap:16px;">
                        <div style="width:48px; height:48px; background:var(--m3-p-c); border-radius:12px; display:grid; place-items:center;">
                            <span class="material-symbols-rounded" style="color:var(--m3-p)">smartphone</span>
                        </div>
                        <div style="flex:1">
                            <h3 style="margin:0; font-size: 1.1rem;">${d.name}</h3>
                            <div style="font-size: 0.8rem; color: var(--m3-out); margin-top: 4px;">${d.description || d.desc || 'Xperia Device'}</div>
                        </div>
                    </div>
                </div>
            `).join('') + `<button onclick="logout()" style="width:100%; background:none; border:1px solid var(--m3-out-var); padding:12px; border-radius:12px; color:var(--m3-out); margin-top:20px;">Sign Out</button>`;
        }

        // --- TIER 2 & 3 (Rest of your functions: selectDevice, selectVariant, renderTier3, etc.) ---
        // Ensure renderTier3 includes the safety checks we discussed previously!

        function renderTier3() {
            const v = state.devices[state.currentDeviceIdx].variants[state.currentVariantIdx];
            const list = v.firmwares || [];
            
            const filtered = list.filter(f => {
                if (!f || !f.ver) return false;
                const searchMatch = f.ver.toLowerCase().includes(state.searchQuery.toLowerCase());
                let filterMatch = (state.filter === 'all') ? true : f.type === state.filter;
                return searchMatch && filterMatch;
            });

            const fwListEl = document.getElementById('fwList');
            fwListEl.innerHTML = filtered.length > 0 ? filtered.map(f => `
                <div class="m3-card" onclick="showDetail('${f.ver}', '${f.date || 'Unknown'}', '${(f.changelog || 'Pending.').replace(/'/g, "\\'")}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700;">${f.ver}</div>
                            <div style="font-size:0.75rem; color:var(--m3-out);">Android ${f.android || 'N/A'} • ${f.date || 'Recent'}</div>
                        </div>
                        <span class="material-symbols-rounded" style="color:var(--m3-p)">arrow_forward</span>
                    </div>
                </div>
            `).join('') : `<p style="text-align:center; color:var(--m3-out); margin-top:40px;">No updates found.</p>`;
        }

        // (Add remaining selectDevice, selectVariant, showDetail, loadCommunityData, setFilter, submitStarOnly, submitTextReport functions here)

        window.selectDevice = (idx) => {
            state.currentDeviceIdx = idx;
            const d = state.devices[idx];
            document.getElementById('variantTitle').innerText = d.name;
            document.getElementById('variantList').innerHTML = (d.variants || []).map((v, i) => `
                <div class="m3-card" onclick="selectVariant(${i})">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700;">${v.model}</div>
                            <div style="font-size:0.8rem; color:var(--m3-out);">${v.region}</div>
                        </div>
                        <span class="material-symbols-rounded">chevron_right</span>
                    </div>
                </div>
            `).join('');
            nav('pageVariants');
        };

        // 2. ADDED DESCRIPTION TO FIRMWARE HEADER
        window.selectVariant = (vIdx) => {
            state.currentVariantIdx = vIdx;
            const d = state.devices[state.currentDeviceIdx];
            const v = d.variants[vIdx];
            document.getElementById('modelCodeHeader').innerText = v.model;
            document.getElementById('currentDeviceName').innerText = d.name;
            document.getElementById('currentDeviceDesc').innerText = d.description || d.desc || "Performance tracking enabled.";
            renderTier3();
            nav('pageFirmwares');
        };

        window.setFilter = (type, el) => {
            state.filter = type; 
            
            // UI Update
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            
            renderTier3();
        };
        window.setFilter = (type, el) => {
            state.filter = type; // This must match 'Security' or 'Android' exactly as defined in the if-statements above
            
            // Update UI chips
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            
            // Re-run the list rendering
            renderTier3();
        };

        window.showDetail = (ver, date, log) => {
            state.currentFwId = ver.replace(/\./g, '_');
            document.getElementById('detVer').innerText = ver;
            document.getElementById('detMeta').innerText = `Official Deployment: ${date}`;
            document.getElementById('detChangelog').innerText = log;
            
            state.userRating = 0;
            document.querySelectorAll('#starSelector span').forEach(s => s.classList.remove('active'));
            
            loadCommunityData(state.currentFwId);
            nav('pageDetail');
        };

        function loadCommunityData(fwId) {
            onValue(ref(db, `feedback/${fwId}`), snap => {
                const data = snap.val() || {};
                let bugs = [], imps = [], totalRating = 0, count = 0;
                Object.values(data).forEach(entry => {
                    if(entry.rating) { totalRating += entry.rating; count++; }
                    if(entry.type === 'bug' && entry.comment) bugs.push(entry.comment);
                    if(entry.type === 'improvement' && entry.comment) imps.push(entry.comment);
                });
                document.getElementById('bugContainer').innerText = bugs.length ? bugs[bugs.length-1] : "No critical bugs.";
                document.getElementById('improvementContainer').innerText = imps.length ? imps[imps.length-1] : "Stable.";
                document.getElementById('avgRatingScore').innerText = count > 0 ? (totalRating / count).toFixed(1) : "0.0";
            });
        }

        window.setFilter = (type, el) => {
            state.filter = type;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderTier3();
        };

        document.getElementById('fwSearchInput').addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            renderTier3();
        });

        window.submitStarOnly = () => {
            if(!state.userRating) return alert("Select stars first!");
            push(ref(db, `feedback/${state.currentFwId}`), { rating: state.userRating, timestamp: Date.now() });
            alert("Vote recorded!");
        };

        window.submitTextReport = () => {
            const comment = document.getElementById('contributionText').value;
            const type = document.getElementById('contributionType').value;
            if(!comment) return;
            push(ref(db, `feedback/${state.currentFwId}`), { comment, type, timestamp: Date.now() });
            document.getElementById('contributionText').value = "";
            alert("Intel submitted.");
        };

        document.querySelectorAll('#starSelector span').forEach(star => {
            star.onclick = () => {
                state.userRating = parseInt(star.dataset.v);
                document.querySelectorAll('#starSelector span').forEach((s, i) => {
                    s.classList.toggle('active', i < state.userRating);
                });
            };
        });

        // Footer Injection for all pages
        // Run this once to inject the footer into all pages
        document.querySelectorAll('.page').forEach(page => {
            const footer = document.createElement('footer');
            footer.className = 'legal-footer';
            footer.innerHTML = `
                <div class="legal-text">
                    <p><strong>XperiVerdict</strong> is an independent community resource.</p>
                    <p>This platform is <strong>not affiliated with, authorized, or endorsed by Sony Group Corporation</strong> or its subsidiaries.</p>
                    <p>SONY and Xperia are registered trademarks of Sony Group Corporation. All other product names, logos, and brands are property of their respective owners.</p>
                    <p>© 2026 XperiVerdict • <a href="terms-and-service.html" class="legal-link">Terms of Service</a></p>
                </div>
            `;
            page.appendChild(footer);
        });
    </script>
</body>
</html>