<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>XperiVerdict Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Google+Sans+Text:wght@400;500&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">

    <style>
        :root {
            --m3-p: #6750a4; 
            --m3-on-p: #ffffff;
            --m3-p-c: #eaddff;
            --m3-on-p-c: #21005d;
            --m3-surf: #f6f2f7; 
            --m3-surf-elevated: #ffffff;
            --m3-out: #79747e;
            --m3-out-var: #c4c7c5;
            --ease-emphasized: cubic-bezier(0.3, 0, 0, 1);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --glass: blur(20px) saturate(180%);
        }

        .profile-circle { 
            width: 40px; 
            height: 40px; 
            background: var(--m3-p-c); /* Light Purple */
            border-radius: 50%; 
            display: grid; 
            place-items: center; 
            cursor: pointer; 
            font-weight: bold; 
            color: var(--m3-p); /* Dark Purple Text */
            text-transform: uppercase;
            flex-shrink: 0; /* Prevents it from being crushed if title is long */
        }

        body { 
            background: var(--m3-surf); 
            font-family: 'Google Sans Text', sans-serif; 
            margin: 0; color: #1d1b20; 
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
        }

        /* Dropdown Menu Container */
        .profile-dropdown {
            display: none;
            position: absolute;
            top: 70px; /* Positioned below the top bar */
            right: 20px;
            width: 240px;
            background: var(--m3-surf-elevated);
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
            transform-origin: top right;
            animation: menuIn 0.2s var(--ease-emphasized);
        }

        @keyframes menuIn {
            from { opacity: 0; transform: scale(0.9) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Dropdown Items */
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s;
            color: #1d1b20;
            font-size: 0.95rem;
        }

        .menu-item:hover { background: rgba(0,0,0,0.04); }

        .menu-item .material-symbols-rounded { color: var(--m3-p); }

        .menu-divider { height: 1px; background: var(--m3-out-var); opacity: 0.3; margin: 4px 0; }

        .modal-overlay { 
            display: none; /* Controlled by JS */
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            display: none; /* We override this to 'flex' in JS */
            align-items: center; 
            justify-content: center; 
        }

        /* Profile UI Additions */
        .profile-comp-container { text-align: center; }
        .avatar-wrapper { position: relative; width: 84px; height: 84px; margin: 0 auto 16px; }
        .avatar-main { 
            width: 100%; height: 100%; background: var(--m3-p); color: white; 
            border-radius: 50%; display: grid; place-items: center; 
            font-size: 2.2rem; font-weight: 500; box-shadow: 0 4px 12px rgba(103, 80, 164, 0.2); 
        }
        .avatar-edit-badge { 
            position: absolute; bottom: 0; right: 0; background: white; 
            border-radius: 50%; width: 28px; height: 28px; display: grid; 
            place-items: center; border: 1px solid var(--m3-out-var); box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page { 
            position: fixed; inset: 0; padding: 0 20px 40px 20px; 
            transition: transform 0.5s var(--ease-emphasized), opacity 0.4s ease;
            overflow-y: auto; background: var(--m3-surf); z-index: 10;
        }
        .page-hidden { transform: scale(0.96) translateY(20px); opacity: 0; pointer-events: none; }

        .top-app-bar { 
            display: flex; 
            flex-direction: row;      /* Ensure horizontal flow */
            align-items: center;      /* Vertically center items */
            justify-content: space-between; /* Pushes Title to Left, Profile to Right */
            padding: 12px 20px; 
            position: sticky; 
            top: 0; 
            background: rgba(246, 242, 247, 0.8); 
            backdrop-filter: var(--glass); 
            -webkit-backdrop-filter: var(--glass); 
            z-index: 100; 
            margin: 0;                /* Remove negative margins if they exist */
            box-sizing: border-box;   /* Ensures padding doesn't break width */
            width: 100%;
        }

        .m3-card {
            background: var(--m3-surf-elevated);
            border-radius: 28px; padding: 20px; margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.03);
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }
        .m3-card:active { transform: scale(0.98); }

        .search-container {
            background: white; border-radius: 16px; padding: 4px 16px;
            display: flex; align-items: center; gap: 12px; margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .search-container input { border: none; background: transparent; outline: none; height: 48px; width: 100%; font-family: inherit; font-size: 1rem; }

        .chip-row { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0 20px; scrollbar-width: none; }
        .chip {
            padding: 10px 20px; border-radius: 12px; background: white;
            font-size: 0.85rem; font-weight: 500; color: var(--m3-out);
            border: 1px solid var(--m3-out-var); cursor: pointer; flex-shrink: 0;
        }
        .chip.active { background: var(--m3-on-p-c); color: white; border-color: var(--m3-on-p-c); }

        .m3-btn {
            background: var(--m3-p); color: white; border: none;
            padding: 14px 28px; border-radius: 16px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 8px; cursor: pointer; width: 100%; justify-content: center;
        }

        .rating-badge { background: var(--m3-p-c); color: var(--m3-on-p-c); padding: 12px 20px; border-radius: 20px; text-align: center; }
        .stat-box { padding: 16px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.05); }
        .label-meta { color: var(--m3-out); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        
        .star-input span { font-size: 38px; color: var(--m3-out-var); cursor: pointer; }
        .star-input span.active { color: #FFB300; font-variation-settings: 'FILL' 1; }

        .legal-footer { padding: 32px 20px 60px 20px; text-align: center; border-top: 1px solid rgba(0,0,0,0.05); margin-top: 20px; }
        .legal-text { font-size: 0.7rem; color: var(--m3-out); line-height: 1.5; }

        /* Review Card Styles */
        .review-card {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 16px;
            margin-bottom: 8px;
            align-items: flex-start;
        }
        .review-avatar {
            width: 32px; height: 32px;
            background: var(--m3-p-c);
            color: var(--m3-p);
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 0.75rem;
            font-weight: 800;
            flex-shrink: 0;
        }
        .review-content { flex: 1; min-width: 0; }
        .review-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2px; }
        .review-user { font-weight: 700; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; }
        .review-time { font-size: 0.65rem; color: var(--m3-out); }
        .review-text { font-size: 0.85rem; line-height: 1.4; color: #1d1b20; }

        .coffee-btn-bar {
            background: #FFDD00;
            color: #000000;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
            margin-left: auto; /* Push to the right before profile */
            margin-right: 8px; /* Added spacing between button and profile circle */
        }
        .coffee-btn-bar:active {
            transform: scale(0.95);
        }
        .coffee-btn-bar .material-symbols-rounded {
            font-size: 20px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px; /* More modern squircle shape */
            border: 1px solid rgba(0,0,0,0.04);
            background: var(--m3-surf-elevated);
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: all 0.25s var(--ease-emphasized);
            flex-shrink: 0;
            color: var(--m3-p);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .icon-btn:hover { 
            background: var(--m3-p-c); 
            border-color: transparent;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(103, 80, 164, 0.15);
        }
        .icon-btn:active { 
            transform: scale(0.92) translateY(0); 
            background: rgba(103, 80, 164, 0.2);
        }
        .icon-btn .material-symbols-rounded { 
            font-size: 22px; 
            transition: transform 0.2s ease;
        }
        .icon-btn:hover .material-symbols-rounded {
            transform: scale(1.1);
        }


        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #322f35;
            color: #f5eff7;
            padding: 12px 24px;
            border-radius: 28px;
            font-size: 0.9rem;
            z-index: 2000;
            transition: transform 0.3s var(--ease-emphasized);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* Review Card Styling */
        .review-card {
            padding: 16px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .review-card:last-child { border-bottom: none; }
        
        .review-avatar { 
            width: 36px; height: 36px; border-radius: 12px; 
            background: var(--m3-p-c); color: var(--m3-p);
            display: grid; place-items: center; font-weight: bold; font-size: 0.9rem;
            flex-shrink: 0;
        }

        .review-content { flex: 1; }
        .review-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
        .review-date { font-size: 0.7rem; color: var(--m3-out); font-weight: 500; }
        .review-text { font-size: 0.9rem; line-height: 1.4; color: #1d1b20; }

        .full-review-item {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .full-review-item:last-child { border-bottom: none; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--m3-out-var); border-radius: 10px; }

        #modalOverlaySuggestion {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(8px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
        }

        .modal-content {
        background: #fff;
        border-radius: 28px;
        padding: 32px 24px;
        width: 100%;
        max-width: 480px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
        }

        .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        }

        .modal-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        }

        .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #79747e;
        cursor: pointer;
        }

        .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        }

        input, textarea {
        padding: 14px;
        border: 1px solid #c4c7c5;
        border-radius: 16px;
        outline: none;
        font-size: 0.95rem;
        }

        input:focus, textarea:focus {
        border-color: #6750a4;
        box-shadow: 0 0 0 2px rgba(103,80,164,0.2);
        }

        .send-btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 16px;
        background-color: #6750a4;
        color: #fff;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        }

        .send-btn:hover {
        background-color: #523b91;
        }

        /* Error toast */
        .toast-error {
        display: none;
        background: #b00020;
        color: #fff;
        padding: 12px 16px;
        border-radius: 16px;
        font-weight: 600;
        text-align: center;
        margin-top: 12px;
        animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
        from {opacity:0; transform: translateY(-5px);}
        to {opacity:1; transform: translateY(0);}
        }

        /* Success card */
        .success-card {
        text-align: center;
        background: #fff;
        border-radius: 28px;
        padding: 40px 24px;
        max-width: 400px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        animation: zoomIn 0.25s ease-out;
        }

        @keyframes zoomIn {
        from {transform: scale(0.95); opacity:0;}
        to {transform: scale(1); opacity:1;}
        }


    </style>
</head>
<body>
    <div id="toast">Link copied to clipboard</div>

    <div id="pageLogin" class="page">
        <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;">
            <div style="width: 80px; height: 80px; background: var(--m3-p-c); border-radius: 24px; display: grid; place-items: center; margin-bottom: 24px;">
                <span class="material-symbols-rounded" style="font-size: 40px; color: var(--m3-p);">cloud</span>
            </div>
            <h1 id="authTitle">XperiVerdict</h1>
            <div class="m3-card" style="width: 100%; max-width: 320px; box-sizing: border-box;">
                <input type="email" id="loginEmail" placeholder="Email" style="width:100%; padding:14px; border-radius:12px; border:1px solid var(--m3-out-var); margin-bottom:12px; box-sizing:border-box;">
                <input type="password" id="loginPass" placeholder="Password" style="width:100%; padding:14px; border-radius:12px; border:1px solid var(--m3-out-var); margin-bottom:20px; box-sizing:border-box;">
                
                <div style="text-align: right; margin: -8px 0 16px 0;">
                    <button type="button" style="background:none; border:none; color:var(--m3-p); font-size:0.8rem; cursor:pointer; font-weight:500;" onclick="handleForgotPassword()">
                        Forgot password?
                    </button>
                </div>

                <button id="mainAuthBtn" class="m3-btn" onclick="handleLogin()">Sign In</button>
                
                <div style="margin-top: 16px; text-align: center;">
                    <button id="toggleAuthBtn" style="background:none; border:none; color:var(--m3-p); font-weight:600; cursor:pointer;" onclick="toggleAuthMode()">Create an account</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pageDevices" class="page">
        <div class="top-app-bar">
            <h1>XperiVerdict</h1>

            <a href="https://www.buymeacoffee.com/redstoneinvente" target="_blank" class="coffee-btn-bar">
                <span class="material-symbols-rounded">coffee</span>
                <span style="white-space: nowrap;">Support</span>
            </a>

            <div class="profile-circle profileBtn" onclick="toggleModal(document.getElementById('profileDropdown').style.display !== 'block')">?</div>
        </div>

        <div class="search-container">
            <span class="material-symbols-rounded">search</span>
            <input type="text" placeholder="Filter version..." id="deviceSearchInput">
        </div>

        <div class="chip-row">
            <div class="chip active" onclick="setDeviceFilter('all', this)">All</div>
            <div class="chip" onclick="setDeviceFilter('1 ', this)">1 Series</div>
            <div class="chip" onclick="setDeviceFilter('5', this)">5 Series</div>
            <div class="chip" onclick="setDeviceFilter('10', this)">10 Series</div>
            <div class="chip" onclick="setDeviceFilter('pro', this)">Pro Series</div>
            <div class="chip" onclick="setDeviceFilter('ace', this)">Ace Series</div>
        </div>

        <div id="deviceList"></div>
    </div>

    <div id="pageVariants" class="page page-hidden">
        <div class="top-app-bar">
            <button style="background:none;border:none;" onclick="nav('pageDevices')"><span class="material-symbols-rounded">arrow_back_ios_new</span></button>
            <h1 id="variantTitle">Models</h1>

            <a href="https://www.buymeacoffee.com/redstoneinvente" target="_blank" class="coffee-btn-bar">
                <span class="material-symbols-rounded">coffee</span>
                <span style="white-space: nowrap;">Support</span>
            </a> 

            <div class="profile-circle profileBtn" onclick="toggleModal(document.getElementById('profileDropdown').style.display !== 'block')">?</div>
        </div>

        <div class="m3-card" style="
            background: var(--m3-p-c); 
            border: none; 
            margin-bottom: 24px; 
            display: flex; 
            align-items: center; 
            padding: 16px; 
            gap: 16px;">
            
            <div id="deviceIconVisual1"></div>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div class="label-meta" style="color: var(--m3-on-p-c); opacity: 0.7; font-size: 0.85rem;">Selected Device</div>
                <h2 id="currentDeviceName2" style="margin: 0; color: var(--m3-on-p-c); line-height: 1.2;">Device</h2>
                <p id="currentDeviceDesc2" style="margin: 0; font-size: 0.9rem; color: var(--m3-on-p-c); opacity: 0.8;"></p>
            </div>
        </div>

        <div id="variantList"></div>
    </div>

    <div id="pageFirmwares" class="page page-hidden">
        <div class="top-app-bar">
            <button style="background:none;border:none;" onclick="nav('pageVariants')"><span class="material-symbols-rounded">arrow_back_ios_new</span></button>
            <div style="flex:1"><h1 id="modelCodeHeader" style="font-size: 1.2rem;">Model</h1></div>

            <a href="https://www.buymeacoffee.com/redstoneinvente" target="_blank" class="coffee-btn-bar">
                <span class="material-symbols-rounded">coffee</span>
                <span style="white-space: nowrap;">Support</span>
            </a>

            <div class="profile-circle profileBtn" onclick="toggleModal(document.getElementById('profileDropdown').style.display !== 'block')">?</div>
        </div>
        
        <div class="m3-card" style="
            background: var(--m3-p-c); 
            border: none; 
            margin-bottom: 24px; 
            display: flex; 
            align-items: center; 
            padding: 16px; 
            gap: 16px;">
            
            <div id="deviceIconVisual2"></div>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div class="label-meta" style="color: var(--m3-on-p-c); opacity: 0.7;">Selected Device</div>
                <h2 id="currentDeviceName" style="margin: 4px 0; color: var(--m3-on-p-c);">Device</h2>
                <p id="currentDeviceDesc" style="margin: 0; font-size: 0.9rem; color: var(--m3-on-p-c); opacity: 0.8;"></p>
            </div>
        </div>

        <div class="search-container">
            <span class="material-symbols-rounded">search</span>
            <input type="text" placeholder="Filter version..." id="fwSearchInput">
        </div>

        <div class="chip-row">
            <div class="chip active" onclick="setFilter('all', this)">All Feeds</div>
            <div class="chip" onclick="setFilter('Security', this)">Security Patches</div>
            <div class="chip" onclick="setFilter('Android', this)">OS Upgrades</div>
        </div>
        <div id="fwList"></div>
    </div>

    <div id="pageDetail" class="page page-hidden">
        <div class="top-app-bar">
            <button style="background:none;border:none;" onclick="nav('pageFirmwares')"><span class="material-symbols-rounded">expand_more</span></button>
            <h1 style="font-size: 1.1rem; flex:1; text-align: center;">Firmware Intelligence</h1>

            <a href="https://www.buymeacoffee.com/redstoneinvente" target="_blank" class="coffee-btn-bar">
                <span class="material-symbols-rounded">coffee</span>
                <span style="white-space: nowrap;">Support</span>
            </a>

            <button class="icon-btn" style="margin: 0 12px 0 0px;" onclick="copyShareLink('pageDetail')" title="Share">
                <span class="material-symbols-rounded">share</span>
            </button>

            <div class="profile-circle profileBtn" onclick="toggleModal(document.getElementById('profileDropdown').style.display !== 'block')">?</div>
        </div>
        
        <div class="m3-card" style="background: var(--m3-on-p-c); color: white; border: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div class="label-meta" style="color: rgba(255,255,255,0.6);">Current Version</div>
                    <h2 id="detVer" style="margin:4px 0 0 0; font-size: 1.8rem;">0.0.0</h2>
                </div>
                <div class="rating-badge">
                    <div id="avgRatingScore" style="font-size: 2rem; font-weight: 700;">0.0</div>
                    <div style="font-size: 0.6rem; font-weight: 800;">INDEX</div>
                </div>
            </div>
            <p id="detMeta" style="margin: 16px 0 0 0; font-size: 0.85rem; opacity: 0.7;"></p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div class="stat-box" onclick="openReviewCategory('bug')">
                <h4 style="margin:0 0 8px 0; color: #ba1a1a; font-size: 0.7rem;">REPORTED BUGS</h4>
                <div id="bugContainer"></div>
                <div style="font-size: 0.7rem; color: var(--m3-p); font-weight: 600; margin-top: 8px;">VIEW ALL →</div>
            </div>
            <div class="stat-box" onclick="openReviewCategory('improvement')">
                <h4 style="margin:0 0 8px 0; color: #006e1c; font-size: 0.7rem;">IMPROVEMENTS</h4>
                <div id="improvementContainer"></div>
                <div style="font-size: 0.7rem; color: var(--m3-p); font-weight: 600; margin-top: 8px;">VIEW ALL →</div>
            </div>
        </div>

        <div class="m3-card">
            <h3 style="margin: 0 0 12px 0; font-size: 1rem;">Official Changelog</h3>
            <p id="detChangelog" style="margin:0; font-size: 0.9rem; line-height: 1.6; color: var(--m3-out);"></p>
        </div>

        <div class="m3-card" style="text-align: center;">
            <div class="label-meta">Community Stability Vote</div>
            <div class="star-input" id="starSelector" style="display: flex; justify-content: center; gap: 4px; margin: 12px 0;">
                <span class="material-symbols-rounded" data-v="1">star</span>
                <span class="material-symbols-rounded" data-v="2">star</span>
                <span class="material-symbols-rounded" data-v="3">star</span>
                <span class="material-symbols-rounded" data-v="4">star</span>
                <span class="material-symbols-rounded" data-v="5">star</span>
            </div>
            <button class="m3-btn" onclick="submitStarOnly()">Cast Stability Vote</button>
        </div>

        <div class="m3-card">
            <div class="label-meta">Submit Intel</div>
            <select id="contributionType" style="width: 100%; padding: 12px; border-radius: 12px; margin-top: 8px;">
                <option value="improvement">Stable Performance</option>
                <option value="bug">Bug Encountered</option>
            </select>
            <textarea id="contributionText" style="width: 100%; height: 80px; padding: 12px; border-radius: 12px; margin: 12px 0; box-sizing: border-box;" placeholder="Add details..."></textarea>
            <button class="m3-btn" style="background: #1d1b20;" onclick="submitTextReport()">Submit Report</button>
        </div>
    </div>

    <div id="profileDropdown" class="profile-dropdown">
        <div style="padding: 20px; background: var(--m3-p-c); display: flex; align-items: center; gap: 12px;">
            <div id="compAvatar" style="width: 40px; height: 40px; background: var(--m3-p); color: white; border-radius: 50%; display: grid; place-items: center; font-weight: bold;">U</div>
            <div style="overflow: hidden;">
                <div id="compUserName" style="font-weight: 700; font-size: 0.9rem; white-space: nowrap; text-overflow: ellipsis;">User</div>
                <div id="compUserEmail" style="font-size: 0.75rem; color: var(--m3-on-p-c); opacity: 0.7; white-space: nowrap; text-overflow: ellipsis;">email@example.com</div>
            </div>
        </div>

        <div class="menu-item" onclick="window.open('https://discord.com/invite/S935qhUwqS', '_blank')">
            <img src="https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/discord.svg"
            alt="Discord"
            width="20"
            height="20">

            <span>Join Our Discord</span>
        </div>

        <div class="menu-item" onclick="toggleModalSuggestion(true)">
            <span class="material-symbols-rounded">lightbulb</span>
            <span>Suggest Change</span>
        </div>

         <div class="menu-divider"></div>

        <div class="menu-item" onclick="window.location.href='settings.html'">
            <span class="material-symbols-rounded">settings</span>
            <span>Account Settings</span>
        </div>
        
        <div class="menu-item" style="color: #ba1a1a;" onclick="handleLogout()">
            <span class="material-symbols-rounded">logout</span>
            <span>Sign Out</span>
        </div>
    </div>

    <div id="pageReviews" class="page page-hidden">
        <div class="top-app-bar">
            <button style="background:none;border:none;cursor:pointer;" onclick="nav('pageDetail')">
                <span class="material-symbols-rounded">arrow_back</span>
            </button>
            <h1 id="reviewTitle" style="font-size: 1.1rem; flex:1; text-align: center;">Feedback</h1>
            <div style="width: 48px;"></div> <!-- Spacer for centering -->
        </div>
        <div id="fullReviewList" class="m3-card" style="padding: 0;">
            <!-- Reviews injected here -->
        </div>
    </div>

    <!-- SUGGESTION MODAL -->
    <!-- MODAL OVERLAY -->
    <div id="modalOverlaySuggestion">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Suggest Change</h2>
                <button class="close-btn" onclick="toggleModalSuggestion(false)">✕</button>
            </div>

            <div class="form-field">
                <label for="suggestModel">Phone Model</label>
                <input type="text" id="suggestModel" placeholder="e.g. Xperia 5 VI">
            </div>

            <div class="form-field">
                <label for="suggestEmail">Contact Email</label>
                <input type="email" id="suggestEmail" placeholder="Your email">
            </div>

            <div class="form-field">
                <label for="suggestChange">Suggested Change</label>
                <textarea id="suggestChange" placeholder="Describe missing data..." rows="4"></textarea>
            </div>

            <button class="send-btn" onclick="submitSuggestion(event)">Send Suggestion</button>

            <!-- M3 toast for errors -->
            <div id="suggestionError" class="toast-error">Failed to send suggestion!</div>
        </div>
    </div>



    <!-- <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="redstoneinvente" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FF813F" data-position="Right" data-x_margin="18" data-y_margin="18"></script> -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, get, update, serverTimestamp  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword,
        sendPasswordResetEmail} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const notFound = `./Resources/Images/Devices/not%20found.svg`;

        const firebaseConfig = {
            apiKey: "AIzaSyA0q57Bv_I4uuRn7cig64DPKa2oviyGHdw",
            authDomain: "xperia-tracker.firebaseapp.com",
            databaseURL: "https://xperia-tracker-default-rtdb.firebaseio.com",
            projectId: "xperia-tracker",
            appId: "1:1028462018440:web:54a8a9d6ae759f2644043d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let state = { devices: [], filteredDevicesTemp: [], currentDeviceIdx: null, currentVariantIdx: null, currentFwId: null, filter: 'all', searchQuery: '', searchQueryDevice: '', userRating: 0 , activeReviews: [], deviceFilter: 'all', deviceYearFilter: 'all'};
        let userNameL = "";
        let userIDL = "";

        let ratingID = -1;
        let currentVisualScore = 0;
        
        let allReviews = [];

        window.copyShareLink = (pageId) => {
            const url = new URL(window.location.href);
            url.searchParams.set('page', pageId);
            
            if (state.currentDeviceIdx !== null) url.searchParams.set('d', state.currentDeviceIdx);
            if (state.currentVariantIdx !== null) url.searchParams.set('v', state.currentVariantIdx);
            if (state.currentFwId !== null && pageId === 'pageDetail') {
                const fw = state.devices[state.currentDeviceIdx].variants[state.currentVariantIdx].firmwares.find(f => f.ver.replace(/\./g, '_') === state.currentFwId);
                if (fw) url.searchParams.set('fw', fw.ver);
            }

            const shareUrl = url.toString();
            
            // Clipboard API
            const dummy = document.createElement('input');
            document.body.appendChild(dummy);
            dummy.value = shareUrl;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);

            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        };

        // Deep Link Handling
        function handleDeepLink() {
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page');
            const d = params.get('d');
            const v = params.get('v');
            const fw = params.get('fw');

            if (d !== null) state.currentDeviceIdx = parseInt(d);
            if (v !== null) state.currentVariantIdx = parseInt(v);

            if (page === 'pageDetail' && fw) {
                // We need data to be loaded first
                const checkData = setInterval(() => {
                    if (state.devices.length > 0) {
                        const dev = state.devices[state.currentDeviceIdx];
                        const variant = dev.variants[state.currentVariantIdx];
                        const targetFw = variant.firmwares.find(f => f.ver === fw);
                        if (targetFw) {
                            showDetail(targetFw.ver, targetFw.date, targetFw.changelog);
                            clearInterval(checkData);
                        }
                    }
                }, 100);
            } else if (page === 'pageFirmwares' && v !== null) {
                const checkData = setInterval(() => {
                    if (state.devices.length > 0) {
                        selectVariant(parseInt(v));
                        clearInterval(checkData);
                    }
                }, 100);
            } else if (page === 'pageDevices') {
                nav('pageDevices');
            }
        }

        // --- AUTH LOGIC ---
        window.handleLogin = () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            if (!email || !pass) {
                alert("Please fill in all fields");
                return;
            }

            signInWithEmailAndPassword(auth, email, pass)
                .catch(err => alert("Login Failed: " + err.message));
        };

        window.handleForgotPassword = () => {
            const email = document.getElementById('loginEmail').value;

            if (!email) {
                alert("Please enter your email address first so we can send a reset link.");
                return;
            }

            sendPasswordResetEmail(auth, email)
                .then(() => {
                    alert("Password reset email sent! Check your inbox (and spam folder).");
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    
                    if (errorCode === 'auth/user-not-found') {
                        alert("No account found with this email.");
                    } else {
                        alert("Error: " + errorMessage);
                    }
                });
        };

        // Ensure 'window.' is present so the HTML onclick can "see" it
        window.handleLogout = () => {
            signOut(auth)
                .then(() => {
                    toggleModal(false); // Close the dropdown
                    console.log("User signed out");
                })
                .catch((error) => {
                    console.error("Sign out error:", error);
                    alert("Error signing out: " + error.message);
                });
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                // 1. Data Prep: Use displayName if it exists, otherwise fallback to email
                const initial = user.displayName ? user.displayName[0].toUpperCase() : (user.email ? user.email[0].toUpperCase() : 'U');
                const userName = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
                
                userNameL = userName;
                userIDL = user.uid;

                // 2. Update Top Bar (The Circle)
                const profileButtons = document.querySelectorAll('.profileBtn');

                profileButtons.forEach(profileBtn => {
                    if (profileBtn) profileBtn.innerText = initial;
                });

                //const profileBtn = document.getElementById('profileBtn');
                
                // 3. Update Dropdown Content
                const compAvatar = document.getElementById('compAvatar');
                const compName = document.getElementById('compUserName');
                const compEmail = document.getElementById('compUserEmail');

                if (compAvatar) compAvatar.innerText = initial;
                if (compName) compName.innerText = userName;
                if (compEmail) compEmail.innerText = user.email;
                
                nav('pageDevices');
                loadData();
                handleDeepLink();
            } else {
                nav('pageLogin');
            }
        });

        window.logout = () => signOut(auth);

        window.toggleModal = (show) => {
            const menu = document.getElementById('profileDropdown');
            if (menu) {
                menu.style.display = show ? 'block' : 'none';
            }
        };

        let isRegisterMode = false;

        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            const title = document.getElementById('authTitle');
            const mainBtn = document.getElementById('mainAuthBtn');
            const toggleBtn = document.getElementById('toggleAuthBtn');

            if (isRegisterMode) {
                title.innerText = "Join XperiVerdict";
                mainBtn.innerText = "Create Account";
                mainBtn.onclick = window.handleRegister;
                toggleBtn.innerText = "Already have an account? Sign In";
            } else {
                title.innerText = "XperiVerdict";
                mainBtn.innerText = "Sign In";
                mainBtn.onclick = window.handleLogin;
                toggleBtn.innerText = "Create an account";
            }
        };

        window.handleRegister = () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            if (pass.length < 6) {
                alert("Password should be at least 6 characters.");
                return;
            }

            createUserWithEmailAndPassword(auth, email, pass)
                .then((userCredential) => {
                    console.log("Registered:", userCredential.user);
                    // onAuthStateChanged will automatically handle the nav to pageDevices
                })
                .catch((error) => {
                    alert("Registration Error: " + error.message);
                });
        };

        // Close dropdown if user clicks anywhere else on the screen
        document.addEventListener('click', (e) => {
        const menu = document.getElementById('profileDropdown');
        const buttons = document.querySelectorAll('.profileBtn');

        if (!menu || menu.style.display !== 'block') return;

        // Check if click was on ANY profile button
        const clickedOnButton = [...buttons].some(btn => btn.contains(e.target));

        if (!menu.contains(e.target) && !clickedOnButton) {
            toggleModal(false);
        }
        });


        // --- NAVIGATION ---
        window.nav = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.add('page-hidden'));
            document.getElementById(id).classList.remove('page-hidden');
        };

        // --- DATA LOADING ---
        function loadData() {
            onValue(ref(db, 'devices'), snap => {
                state.devices = snap.val() || [];
                renderTier1();
            });
        }

        window.toggleModalSuggestion = function (show) {
            const modal = document.getElementById('modalOverlaySuggestion');
            if (!modal) return;
            if (show) {
                modal.style.display = 'flex';
                modal.classList.add('show');   // triggers animation
            } else {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        }

        toggleModalSuggestion(false);

        document.getElementById('modalOverlaySuggestion').addEventListener('click', (e) => {
            const modalContent = e.currentTarget.querySelector('.modal-content');
            if (!modalContent.contains(e.target)) {
                toggleModalSuggestion(false);
            }
        });

        window.submitSuggestion = async function(e) {
            e.preventDefault();

            const model1 = document.getElementById('suggestModel').value;
            const email1 = document.getElementById('suggestEmail').value;
            const change1 = document.getElementById('suggestChange').value;
            const errorDiv = document.getElementById('suggestionError');

            const scriptURL = "https://script.google.com/macros/s/AKfycbxKuPju90YVtchM3uKhJT0XOhlDtGfFpniuFqM0OGvou84pTn8mF6_pbVpfirweU_mv/exec";

            try {
                await fetch(scriptURL, { 
                    method: 'POST', 
                    body: JSON.stringify({ model: model1, email: email1, change: change1 }),
                    mode: 'no-cors'
                });

                // On success: hide modal & show success card
                const overlay = document.getElementById('modalOverlaySuggestion');
                overlay.style.display = 'none';

                const successCard = document.createElement('div');
                successCard.className = 'success-card';
                successCard.innerHTML = `
                    <h2>Request Received!</h2>
                    <p>A verification email has been sent to <strong>${email1}</strong>.<br>We will review your suggestion shortly.</p>
                    <button onclick="location.reload()" class="send-btn" style="margin-top:20px;">Back to Home</button>
                `;
                document.body.appendChild(successCard);

            } catch (error) {
                // Show error toast
                errorDiv.textContent = "Failed to send suggestion!";
                errorDiv.style.display = 'block';
                setTimeout(() => { errorDiv.style.display = 'none'; }, 4000);
            }
        }


        /*
        mask: url('./Resources/Images/Devices/${encodeURIComponent(d.name)}.svg') no-repeat center;
                                -webkit-mask: url('./Resources/Images/Devices/${encodeURIComponent(d.name)}.svg') no-repeat center;
        */

        // 1. MAIN LIST (WITH DESCRIPTION)
        function renderTier1() {

            const list = state.devices || [];

            const filtered = list.filter(f => {
                if (!f) return false;
                const searchMatch = f.name.toLowerCase().includes(state.searchQueryDevice.toLowerCase());

                if (state.deviceFilter === 'all') {
                    return searchMatch;
                }

                let filterMatch = false;

                let deviceNameMatch = f.name.toLowerCase().includes(state.deviceFilter.toLowerCase());

                if (deviceNameMatch) {
                    filterMatch = true;
                }

                return searchMatch && filterMatch;
            });

            state.filteredDevicesTemp = filtered;

            document.getElementById('deviceList').innerHTML = filtered.map((d, i) => `
                <div class="m3-card" onclick="selectDevice(${list.indexOf(d)})">
                    <div style="display:flex; align-items:center; gap:16px;">
                        <div style="width:72px; height:72px; background:var(--m3-p-c); border-radius:12px; display:grid; place-items:center;">
                            <div class="device-mask" style="
                                width: 90%;
                                height: 90%;
                                background-color: var(--m3-on-p-c);
                                mask: url('./Resources/Images/Devices/not%20found.svg') no-repeat center;
                                -webkit-mask: url('./Resources/Images/Devices/not%20found.svg') no-repeat center;
                                mask-size: 95% 95%;">
                            </div>
                        </div>
                        <div style="flex:1">
                            <h3 style="margin:0; font-size: 1.1rem;">${d.name}</h3>
                            <div style="font-size: 0.8rem; color: var(--m3-out); margin-top: 4px;">${d.description || d.desc || 'Xperia Device'}</div>
                        </div>
                    </div>
                </div>
            `).join('') + `<button onclick="logout()" style="width:100%; background:none; border:1px solid var(--m3-out-var); padding:12px; border-radius:12px; color:var(--m3-out); margin-top:20px;">Sign Out</button>`;
        
            updateMasks();
        }

        function toggleDeviceChips(show) {
            const el = document.getElementById('deviceYearChip');
            el.style.display = show ? 'flex' : 'none';
        }

        function checkFileExists(url) {
            return new Promise(resolve => {
                const img = new Image();
                img.src = url;
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
            });
        }

        async function updateMasks() {
            const masks = document.querySelectorAll('#deviceList .device-mask');

            for (let i = 0; i < state.filteredDevicesTemp.length; i++) {
                let index = state.devices.indexOf(state.filteredDevicesTemp[i]);

                const d = state.devices[index];
                const maskDiv = masks[i];

                const fileName = encodeURIComponent(d.name);
                const url = `./Resources/Images/Devices/${fileName}.svg`;
                const fallback = notFound; // optional

                const exists = checkFileExists(url).then(exists => {
                    const maskFile = exists ? url : fallback;
                    maskDiv.style.maskImage = `url('${maskFile}')`;
                    maskDiv.style.webkitMaskImage = `url('${maskFile}')`;
                });
            }
        }

        // --- TIER 2 & 3 (Rest of your functions: selectDevice, selectVariant, renderTier3, etc.) ---
        // Ensure renderTier3 includes the safety checks we discussed previously!

        function renderTier3() {
            const v = state.devices[state.currentDeviceIdx].variants[state.currentVariantIdx];
            const list = v.firmwares || [];
            
            const filtered = list.filter(f => {
                if (!f || !f.ver) return false;
                const searchMatch = f.ver.toLowerCase().includes(state.searchQuery.toLowerCase());

                if (state.filter === 'all') {
                    return searchMatch;
                }

                let filterMatch = false;

                if (state.filter === 'Android' && f.type === 'os') {
                    filterMatch = true;
                }

                if (state.filter === 'Security' && f.type === 'security') {
                    filterMatch = true;
                }

                return searchMatch && filterMatch;
            });

            const fwListEl = document.getElementById('fwList');
            fwListEl.innerHTML = filtered.length > 0 ? filtered.map(f => `
                <div class="m3-card" onclick="showDetail('${f.ver}', '${f.date || 'Unknown'}', '${(f.changelog || f.log || 'Pending.').replace(/'/g, "\\'")}')">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700;">${f.ver}</div>
                            <div style="font-size:0.75rem; color:var(--m3-out);">Android ${f.android || 'N/A'} • ${f.date || 'Recent'}</div>
                        </div>
                        <span class="material-symbols-rounded" style="color:var(--m3-p)">arrow_forward</span>
                    </div>
                </div>
            `).join('') : `<p style="text-align:center; color:var(--m3-out); margin-top:40px;">No updates found.</p>`;
        }

        // (Add remaining selectDevice, selectVariant, showDetail, loadCommunityData, setFilter, submitStarOnly, submitTextReport functions here)

        window.selectDevice = (idx) => {
            state.currentDeviceIdx = idx;
            const d = state.devices[idx];

            document.getElementById('currentDeviceName2').innerText = d.name;
            document.getElementById('currentDeviceDesc2').innerText = d.description || d.desc || "Performance tracking enabled.";

            const newSrc = `./Resources/Images/Devices/${encodeURIComponent(d.name)}.svg`;
            const el = document.getElementById("deviceIconVisual1");

            const img = new Image();
            img.src = newSrc;

            img.onerror = () => {
                el.innerHTML = `
                <div id="deviceIconVisual1"
                style="
                    width: 8rem;
                    height: 8rem;
                    background-color: var(--m3-on-p-c);

                    mask-image: url('${notFound}');
                    mask-repeat: no-repeat;
                    mask-position: center;
                    mask-size: 95% 95%;

                    -webkit-mask-image: url('${notFound}');
                    -webkit-mask-repeat: no-repeat;
                    -webkit-mask-position: center;
                    -webkit-mask-size: 96% 96%;
                ">
            </div>
                `;
            };

            el.innerHTML = `
            <div id="deviceIconVisual1"
                style="
                    width: 8rem;
                    height: 8rem;
                    background-color: var(--m3-on-p-c);

                    mask-image: url('./Resources/Images/Devices/${encodeURIComponent(d.name)}.svg');
                    mask-repeat: no-repeat;
                    mask-position: center;
                    mask-size: 95% 95%;

                    -webkit-mask-image: url('./Resources/Images/Devices/${encodeURIComponent(d.name)}.svg');
                    -webkit-mask-repeat: no-repeat;
                    -webkit-mask-position: center;
                    -webkit-mask-size: 96% 96%;
                ">
            </div>
            `;

            document.getElementById('variantTitle').innerText = d.name;
            document.getElementById('variantList').innerHTML = (d.variants || []).map((v, i) => `
                <div class="m3-card" onclick="selectVariant(${i})">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:700;">${v.model}</div>
                            <div style="font-size:0.8rem; color:var(--m3-out);">${v.region}</div>
                        </div>
                        <span class="material-symbols-rounded">chevron_right</span>
                    </div>
                </div>
            `).join('');
            nav('pageVariants');
        };

        // 2. ADDED DESCRIPTION TO FIRMWARE HEADER
        window.selectVariant = (vIdx) => {
            state.currentVariantIdx = vIdx;
            const d = state.devices[state.currentDeviceIdx];
            const v = d.variants[vIdx];
            document.getElementById('modelCodeHeader').innerText = v.model;
            document.getElementById('currentDeviceName').innerText = d.name;
            document.getElementById('currentDeviceDesc').innerText = d.description || d.desc || "Performance tracking enabled.";

            let newSrc = `./Resources/Images/Devices/${encodeURIComponent(d.name)}.svg`;
            const el = document.getElementById("deviceIconVisual2");

            const img = new Image();
            img.src = newSrc;

            img.onerror = () => {
                el.innerHTML = `
                <div id="deviceIconVisual2"
                    style="
                        width: 8rem;
                        height: 8rem;
                        background-color: var(--m3-on-p-c);

                        mask-image: url('${notFound}');
                        mask-repeat: no-repeat;
                        mask-position: center;
                        mask-size: 95% 95%;

                        -webkit-mask-image: url('${notFound}');
                        -webkit-mask-repeat: no-repeat;
                        -webkit-mask-position: center;
                        -webkit-mask-size: 96% 96%;
                    ">
                </div>
                `;
            };

            el.innerHTML = `
            <div id="deviceIconVisual2"
                style="
                    width: 8rem;
                    height: 8rem;
                    background-color: var(--m3-on-p-c);

                    mask-image: url('./Resources/Images/Devices/${encodeURIComponent(d.name)}.svg');
                    mask-repeat: no-repeat;
                    mask-position: center;
                    mask-size: 95% 95%;

                    -webkit-mask-image: url('./Resources/Images/Devices/${encodeURIComponent(d.name)}.svg');
                    -webkit-mask-repeat: no-repeat;
                    -webkit-mask-position: center;
                    -webkit-mask-size: 96% 96%;
                ">
            </div>
            `;

            renderTier3();
            nav('pageFirmwares');
        };

        window.setFilter = (type, el) => {
            state.filter = type; 
            
            // UI Update
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            
            renderTier3();
        };

        window.setDeviceFilter = (type, el) => {
            state.deviceFilter = type; 
            
            // UI Update
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');

            renderTier1();
        };

        window.setDeviceYearFilter = (type, el) => {
            state.deviceYearFilter = type;
            
            // UI Update
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');

            renderTier1();
        };

        window.showDetail = (ver, date, log) => {
            state.currentFwId = ver.replace(/\./g, '_');
            document.getElementById('detVer').innerText = ver;
            document.getElementById('detMeta').innerText = `Official Deployment: ${date}`;
            document.getElementById('detChangelog').innerText = log;
            
            state.userRating = 0;
            document.querySelectorAll('#starSelector span').forEach(s => s.classList.remove('active'));
            
            loadCommunityData(state.currentFwId);
            nav('pageDetail');
        };

        function loadCommunityData(fwId) {
            const currentDeviceName = state.devices[state.currentDeviceIdx]?.name;
            const modelCode = state.devices[state.currentDeviceIdx]?.variants[state.currentVariantIdx]?.model;

            onValue(ref(db, `feedback/${currentDeviceName}/${modelCode}/${fwId}`), snap => {
                const data = snap.val() || {};
                let bugs = [], imps = [], totalRating = 0, count = 0;
                
                Object.values(data).forEach(entry => {
                    //if(entry.rating) { totalRating += entry.rating; count++; }
                    if(entry.type === 'bug' && entry.comment) bugs.push(entry);
                    if(entry.type === 'improvement' && entry.comment) imps.push(entry);

                    allReviews.push(entry);
                });

                //document.getElementById('avgRatingScore').innerText = count > 0 ? (totalRating / count).toFixed(1) : "No Ratings";

                // Injecting Bugs logic
                const bugContainer = document.getElementById('bugContainer');
                if (bugs.length > 0) {
                    bugContainer.innerHTML = bugs.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0))
                        .slice(0, 3)
                        .map(b => createReviewCard(b))
                        .join('');
                } else {
                    bugContainer.innerHTML = '<div style="padding:20px; color:var(--m3-out); font-size:0.8rem;">No critical issues reported.</div>';
                }

                // Injecting Improvements logic
                const impContainer = document.getElementById('improvementContainer');
                if (imps.length > 0) {
                    impContainer.innerHTML = imps.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0))
                        .slice(0, 3)
                        .map(i => createReviewCard(i))
                        .join('');
                } else {
                    impContainer.innerHTML = '<div style="padding:20px; color:var(--m3-out); font-size:0.8rem;">Stable performance reported.</div>';
                }
            });

            onValue(ref(db, `ratings/${currentDeviceName}/${modelCode}/${state.currentFwId}`), snap => {
                const data = snap.val() || {};
                let totalRating = 0, count = 0;
                
                Object.values(data).forEach(entry => {
                    totalRating += entry.rating; 

                    if (entry.userId === userIDL){
                        showRating(entry.rating);
                        ratingID = count;
                    }

                    count++; 
                });

                let finalScore = (totalRating / count).toFixed(1);

                document.getElementById('avgRatingScore').innerText = count > 0 ? finalScore : "No Ratings";
                animateScore(finalScore);
            });
        }

        function showRating(starRating){
            document.querySelectorAll('#starSelector span').forEach((s, i) => {
                s.classList.toggle('active', i < starRating);
            });
        }

        function animateScore(targetValue) {
            const el = document.getElementById('avgRatingScore');
            const startValue = currentVisualScore;
            const duration = 1600;
            const startTime = performance.now();

            function update(now) {
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease Out Expo
                const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                
                const currentValue = startValue + (targetValue - startValue) * easeProgress;
                el.innerText = currentValue.toFixed(1);
                currentVisualScore = currentValue;

                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    el.innerText = targetValue.toFixed(1);
                    currentVisualScore = targetValue;
                }
            }
            requestAnimationFrame(update);
        }

        function formatDate(timestamp) {
            if(!timestamp) return "Recently";
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function createReviewCard(entry) {
            const userEmail = entry.userName || "Anonymous";
            const initial = entry.userName[0].toUpperCase();
            const time = formatDate(entry.timestamp);
            
            return `
                <div class="review-card">
                    <div class="review-avatar">${initial}</div>
                    <div class="review-content">
                        <div class="review-header">
                            <span class="review-user">${userEmail.split('@')[0]}</span>
                            <span class="review-time">${time}</span>
                        </div>
                        <div class="review-text">${entry.comment}</div>
                    </div>
                </div>
            `;
        }

        window.setFilter = (type, el) => {
            state.filter = type;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderTier3();
        };

        document.getElementById('fwSearchInput').addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            renderTier3();
        });

        document.getElementById('deviceSearchInput').addEventListener('input', (e) => {
            state.searchQueryDevice = e.target.value;
            renderTier1();
        });

        window.submitStarOnly = async () => {
            const user = auth.currentUser;
            if (!user) return alert("You must be signed in.");
            if(!state.userRating) return alert("Select stars!");
            
            const currentDeviceName = state.devices[state.currentDeviceIdx]?.name;
            const modelCode = state.devices[state.currentDeviceIdx]?.variants[state.currentVariantIdx]?.model;

            if(!currentDeviceName || !modelCode) return alert("Error determining device.");

            const ratingRef = ref(db, `ratings/${currentDeviceName}/${modelCode}/${state.currentFwId}`);
            
            try {
                // Fetch existing ratings at this path to see if user has already voted
                const snapshot = await get(ratingRef);
                const data = snapshot.val() || {};
                
                // Find existing key for this user
                let existingKey = null;
                Object.keys(data).forEach(key => {
                    if(data[key].userId === user.uid) existingKey = key;
                });

                const payload = { 
                    rating: state.userRating, 
                    userId: user.uid, 
                    userName: user.displayName || user.email.split('@')[0],
                    userEmail: user.email,
                    timestamp: Date.now() 
                };

                if(existingKey) {
                    // UPDATE existing vote
                    await update(ref(db, `ratings/${currentDeviceName}/${modelCode}/${state.currentFwId}/${existingKey}`), payload);
                } else {
                    // PUSH new vote
                    await push(ratingRef, payload);
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        };

        window.submitTextReport = () => {
            const user = auth.currentUser;
            if (!user) return alert("You must be signed in.");
            const comment = document.getElementById('contributionText').value.trim();
            const type = document.getElementById('contributionType').value;
            if(!comment) return alert("Please enter details.");
            
            const currentDeviceName = state.devices[state.currentDeviceIdx]?.name;
            const modelCode = state.devices[state.currentDeviceIdx]?.variants[state.currentVariantIdx]?.model;

            push(ref(db, `feedback/${currentDeviceName}/${modelCode}/${state.currentFwId}`), { 
                comment, 
                type, 
                userId: user.uid, 
                userName: userNameL,
                userEmail: user.email,
                timestamp: Date.now() 
            });
            
            document.getElementById('contributionText').value = "";
        };

        document.querySelectorAll('#starSelector span').forEach(star => {
            star.onclick = () => {
                state.userRating = parseInt(star.dataset.v);
                document.querySelectorAll('#starSelector span').forEach((s, i) => {
                    s.classList.toggle('active', i < state.userRating);
                });
            };
        });

        // UI Injection for specific review categories
        window.openReviewCategory = (type) => {
            const title = type === 'bug' ? 'Reported Issues' : 'Improvements & Pros';
            document.getElementById('reviewTitle').innerText = title;
            
            const listEl = document.getElementById('fullReviewList');
            const filtered = allReviews.filter(r => r.type === type);

            listEl.innerHTML = "";

            if (filtered.length === 0) {
                listEl.innerHTML = `<div style="padding:40px; text-align:center; color:gray;">No feedback submitted yet.</div>`;
            } else {
                listEl.innerHTML = filtered.map(r => `
                    <div class="full-review-item" style="display:flex; gap:10px; align-items:flex-start;">
                    
                    <!-- Profile Picture -->
                    <div class="review-avatar">${r.userName[0].toUpperCase()}</div>

                    <!-- Review Content -->
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                            
                            <!-- Username + Date -->
                            <div>
                                <div style="font-size:0.85rem; font-weight:600;">
                                    ${r.userName || 'Anonymous'}
                                </div>
                                <span class="label-meta" style="font-size:0.65rem;">
                                    ${new Date(r.timestamp).toLocaleDateString()}
                                </span>
                            </div>

                            <!-- Verified Badge -->
                            <span style="color: var(--m3-p); font-size: 0.8rem; font-weight:600;">
                                Verified User
                            </span>
                        </div>

                        <!-- Comment -->
                        <div style="font-size: 0.95rem; line-height:1.4;">
                            ${r.comment}
                        </div>
                    </div>
                </div>
                `).join('');
            }

            nav('pageReviews');
        };

        // Footer Injection for all pages
        // Run this once to inject the footer into all pages
        document.querySelectorAll('.page').forEach(page => {
            const footer = document.createElement('footer');
            footer.className = 'legal-footer';
            footer.innerHTML = `
                <div class="legal-text">
                    <p><strong>XperiVerdict</strong> is an independent community resource.</p>
                    <p>This platform is <strong>not affiliated with, authorized, or endorsed by Sony Group Corporation</strong> or its subsidiaries.</p>
                    <p>SONY and Xperia are registered trademarks of Sony Group Corporation. All other product names, logos, and brands are property of their respective owners.</p>
                    <p>© 2026 XperiVerdict • <a href="terms-and-service.html" class="legal-link">Terms of Service</a></p>
                </div>
            `;
            page.appendChild(footer);
        });
    </script>
</body>
</html>