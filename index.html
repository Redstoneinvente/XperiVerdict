<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xperia Tracker | Material You</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --m3-surface: #f7f9ff;
            --m3-surface-container: #edf1f9;
            --m3-primary: #006495;
            --m3-primary-container: #d1e4ff;
            --m3-on-primary-container: #001d36;
            --m3-outline: #74777f;
            --m3-text: #1a1c1e;
        }

        body { background: var(--m3-surface); color: var(--m3-text); font-family: 'Google Sans', sans-serif; margin: 0; }

        /* --- AUTH SCREEN --- */
        #authScreen { display: none; height: 100vh; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .auth-card { background: white; padding: 40px; border-radius: 28px; max-width: 400px; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; }
        .m3-input { width: 100%; padding: 14px 18px; border-radius: 14px; border: 1px solid var(--m3-outline); margin-bottom: 16px; box-sizing: border-box; font-family: inherit; }

        /* --- MAIN UI --- */
        #mainUI { display: none; }
        .app-bar { padding: 16px 24px; display: flex; align-items: center; gap: 16px; background: var(--m3-surface); position: sticky; top: 0; z-index: 100; }
        .search-field { background: var(--m3-surface-container); height: 56px; flex: 1; border-radius: 28px; display: flex; align-items: center; padding: 0 20px; }
        .search-field input { border: none; background: transparent; outline: none; width: 100%; margin-left: 12px; font-family: inherit; font-size: 1rem; }

        /* --- GRID & CARDS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .m3-card { background: var(--m3-surface-container); border-radius: 28px; padding: 24px; cursor: pointer; border: none; transition: 0.2s; }
        .m3-card:hover { background: var(--m3-primary-container); transform: translateY(-4px); }

        /* --- DETAIL SHEET --- */
        .m3-sheet { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--m3-surface); z-index: 1000; transform: translateY(100%); transition: 0.4s cubic-bezier(0.05, 0.7, 0.1, 1); overflow-y: auto; }
        .m3-sheet.active { transform: translateY(0); }
        .sheet-header { padding: 20px 24px; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; background: var(--m3-surface); border-bottom: 1px solid var(--m3-surface-container); }
        .sheet-body { padding: 24px; max-width: 800px; margin: 0 auto; }

        .variant-section { background: white; border-radius: 24px; padding: 24px; margin-bottom: 16px; border: 1px solid var(--m3-surface-container); }
        .fw-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--m3-surface-container); }
        .fw-ver { font-family: 'Roboto Mono', monospace; font-weight: 700; color: var(--m3-primary); }

        /* --- BUTTONS --- */
        .btn { padding: 12px 24px; border-radius: 100px; border: none; font-family: inherit; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--m3-primary); color: white; }
        .btn-tonal { background: var(--m3-primary-container); color: var(--m3-on-primary-container); }
        .btn-text { background: transparent; color: var(--m3-primary); font-size: 0.85rem; }

        #loadingScreen { position: fixed; inset: 0; background: var(--m3-surface); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    </style>
</head>
<body>

    <div id="loadingScreen"><span class="material-symbols-rounded" style="font-size: 48px; color: var(--m3-primary);">sync</span></div>

    <section id="authScreen">
        <div class="auth-card">
            <h2 id="authTitle">Xperia Cloud</h2>
            <p id="authSub">Sign in to track firmwares</p>
            <input type="email" id="email" class="m3-input" placeholder="Email">
            <input type="password" id="password" class="m3-input" placeholder="Password">
            <button class="btn btn-primary" id="authBtn" style="width:100%; justify-content:center">Sign In</button>
            
            <div style="margin-top: 16px; display: flex; flex-direction: column; gap: 4px;">
                <button class="btn btn-text" id="toggleAuth" style="justify-content:center">Create an account</button>
                <button class="btn btn-text" id="forgotBtn" style="justify-content:center; opacity: 0.7;">Forgot password?</button>
            </div>
        </div>
    </section>

    <section id="mainUI">
        <div class="app-bar">
            <div class="search-field">
                <span class="material-symbols-rounded">search</span>
                <input type="text" id="searchInput" placeholder="Search devices..." oninput="render()">
            </div>
            <button class="btn btn-tonal" onclick="signOutUser()">Sign Out</button>
        </div>
        <div id="deviceGrid" class="container"></div>
    </section>

    <div id="detailSheet" class="m3-sheet">
        <div class="sheet-header">
            <button class="btn btn-tonal" style="padding: 10px;" onclick="closeSheet()">
                <span class="material-symbols-rounded">close</span>
            </button>
            <h2 id="sheetTitle" style="margin:0; font-weight: 500;"></h2>
        </div>
        <div id="sheetBody" class="sheet-body"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            sendPasswordResetEmail,
            signOut 
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0q57Bv_I4uuRn7cig64DPKa2oviyGHdw",
            authDomain: "xperia-tracker.firebaseapp.com",
            databaseURL: "https://xperia-tracker-default-rtdb.firebaseio.com",
            projectId: "xperia-tracker",
            appId: "1:1028462018440:web:54a8a9d6ae759f2644043d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let devices = [];
        let isLoginMode = true;

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, (user) => {
            document.getElementById('loadingScreen').style.display = 'none';
            if (user) {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainUI').style.display = 'block';
                fetchData();
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainUI').style.display = 'none';
            }
        });

        // Sign In / Register
        document.getElementById('authBtn').onclick = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(!email || !pass) return alert("Please fill in all fields.");

            try {
                if (isLoginMode) await signInWithEmailAndPassword(auth, email, pass);
                else await createUserWithEmailAndPassword(auth, email, pass);
            } catch (err) { alert(err.message); }
        };

        // Forgot Password
        document.getElementById('forgotBtn').onclick = async () => {
            const email = document.getElementById('email').value;
            if (!email) return alert("Please enter your email address first.");

            try {
                await sendPasswordResetEmail(auth, email);
                alert("Password reset link sent to your email!");
            } catch (err) {
                alert(err.message);
            }
        };

        document.getElementById('toggleAuth').onclick = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('authTitle').innerText = isLoginMode ? "Xperia Cloud" : "Create Account";
            document.getElementById('authBtn').innerText = isLoginMode ? "Sign In" : "Register";
            document.getElementById('toggleAuth').innerText = isLoginMode ? "Create an account" : "Back to Sign In";
            document.getElementById('forgotBtn').style.display = isLoginMode ? 'flex' : 'none';
        };

        window.signOutUser = () => signOut(auth);

        // --- DATA & UI ---
        function fetchData() {
            onValue(ref(db, 'devices'), (snap) => {
                devices = snap.val() || [];
                render();
            });
        }

        window.render = () => {
            const grid = document.getElementById('deviceGrid');
            const search = document.getElementById('searchInput').value.toLowerCase();
            grid.innerHTML = devices.map((d, i) => {
                if(search && !d.name.toLowerCase().includes(search)) return '';
                const latest = d.variants?.[0]?.firmwares?.[0]?.ver || "N/A";
                return `
                <div class="m3-card" onclick="openSheet(${i})">
                    <h3 style="margin:0">${d.name}</h3>
                    <p style="font-size:0.85rem; color:var(--m3-outline); margin:8px 0">${d.variants?.length || 0} Variants</p>
                    <div style="background:white; display:inline-block; padding:4px 12px; border-radius:8px; font-size:0.75rem; font-weight:700">Latest: ${latest}</div>
                </div>`;
            }).join('');
        };

        window.openSheet = (idx) => {
            const d = devices[idx];
            document.getElementById('sheetTitle').innerText = d.name;
            const body = document.getElementById('sheetBody');
            
            body.innerHTML = (d.variants || []).map(v => `
                <div class="variant-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
                        <span style="font-weight:700">${v.model} (${v.region})</span>
                    </div>
                    <div class="fw-list">
                        ${(v.firmwares || []).map(f => `
                            <div class="fw-item">
                                <div>
                                    <div class="fw-ver">${f.ver}</div>
                                    <div style="font-size:0.75rem; color:var(--m3-outline)">${f.date}</div>
                                </div>
                                <span style="font-weight:700; font-size:0.8rem">Android ${f.android}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            document.getElementById('detailSheet').classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeSheet = () => {
            document.getElementById('detailSheet').classList.remove('active');
            document.body.style.overflow = 'auto';
        };
    </script>
</body>
</html>