<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XperiVerdict | Community Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@500;700&family=Google+Sans+Text:wght@400;500&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
    <link href="./styles.css" rel="stylesheet">

    <style>
        :root {
            --m3-p: #6750a4;
            --m3-on-p: #ffffff;
            --m3-p-c: #eaddff;
            --m3-on-p-c: #21005d;
            --m3-surf: #f6f2f7;
            --m3-out: #79747e;
            --m3-err: #b3261e;
            --ease: cubic-bezier(0.2, 0, 0, 1);
            --md-sys-color-primary: #6750A4;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;

            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-high: #ECE6F0;
            --md-sys-color-surface-container-highest: #E6E0E9;

            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
        }

        body { font-family: 'Google Sans Text', sans-serif; background: var(--m3-surf); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #1d1b20; }
        nav { width: 300px; background: white; border-right: 1px solid rgba(0,0,0,0.05); padding: 24px; display: flex; flex-direction: column; gap: 8px; }
        .nav-btn { padding: 16px 24px; border-radius: 28px; cursor: pointer; border: none; background: transparent; text-align: left; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; color: #49454f; }
        .nav-btn.active { background: var(--m3-p-c); color: var(--m3-on-p-c); }
        .nav-btn:hover:not(.active) { background: rgba(0,0,0,0.04); }

        main { flex: 1; overflow-y: auto; padding: 40px; }
        .section { display: none; max-width: 1000px; margin: 0 auto; animation: fadeIn 0.4s var(--ease); }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .admin-card { background: white; border-radius: 28px; padding: 28px; margin-bottom: 24px; border: 1px solid rgba(0,0,0,0.03); position: relative; }
        h1 { font-family: 'Google Sans'; font-size: 2.5rem; margin-bottom: 32px; letter-spacing: -0.5px; }
        
        .m3-field { margin-bottom: 20px; }
        .m3-field label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 8px; color: var(--m3-p); margin-left: 4px; }
        input, textarea, select { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid var(--m3-out); font-family: inherit; box-sizing: border-box; background: transparent; }
        textarea { height: 100px; resize: none; }

        #modalOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; place-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .m3-dialog { background: var(--m3-surf); width: 95%; max-width: 550px; padding: 24px; border-radius: 28px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }

        .btn { padding: 12px 24px; border-radius: 20px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-p { background: var(--m3-p); color: white; }
        .btn-text { background: transparent; color: var(--m3-p); }

        .variant-chip { display: inline-flex; align-items: center; gap: 12px; background: #fff; padding: 8px 16px; border-radius: 16px; margin: 6px; font-size: 0.9rem; border: 1px solid rgba(0,0,0,0.08); }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 16px; color: var(--m3-out); font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 16px; border-top: 1px solid var(--m3-surf); font-size: 0.9rem; }
        
        .type-tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; }
        .tag-os { background: #e3f2fd; color: #1976d2; }
        .tag-sec { background: #f1f8e9; color: #388e3c; }

        .history-item { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); }

        /* ---- Card Surface ---- */
.admin-card.srch{
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px 24px;
    border-radius: 28px;

    box-shadow:
        0 1px 2px rgba(0,0,0,.08),
        0 2px 6px rgba(0,0,0,.06);

    max-width: 100%;
}

/* ---- Search Container ---- */
.search-container {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;

    height: 56px;
    padding: 0 16px;
    border-radius: 28px;

    background: var(--md-sys-color-surface-container-high);
    color: var(--md-sys-color-on-surface-variant);

    transition: background .2s ease, box-shadow .2s ease;
}

.search-container span {
    font-size: 22px;
    opacity: .75;
}

.search-container input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;

    font-size: 16px;
    color: var(--md-sys-color-on-surface);
}

.search-container:focus-within {
    background: var(--md-sys-color-surface-container-highest);
    box-shadow: 0 0 0 2px var(--md-sys-color-primary);
}

/* ---- Primary Tonal Button ---- */
.btn.btn-p {
    height: 56px;
    padding: 0 24px;
    border-radius: 28px;

    display: inline-flex;
    align-items: center;
    gap: 8px;

    background: var(--md-sys-color-primary-container);
    color: var(--md-sys-color-on-primary-container);

    font-weight: 500;
    border: none;
    cursor: pointer;

    transition: transform .15s ease, box-shadow .15s ease;
}

.btn.btn-p span {
    font-size: 20px;
}

.btn.btn-p:hover {
    box-shadow:
        0 2px 6px rgba(0,0,0,.12),
        0 4px 12px rgba(0,0,0,.08);
    transform: translateY(-1px);
}

.btn.btn-p:active {
    transform: translateY(0);
    box-shadow: none;
}

.page {
    position: fixed;
    inset: 0;
    padding: 0 20px 40px 20px;
    transition: transform 0.5s var(--ease-emphasized), opacity 0.4s ease;
    overflow-y: auto;
    background: var(--m3-surf);
    z-index: 10;
}

.page-hidden {
    transform: scale(0.96) translateY(20px);
    opacity: 0;
    pointer-events: none;
}
    </style>
</head>
<body>

    <div id="modalOverlay">
        <div class="m3-dialog">
            <h2 id="modalTitle">Modal</h2>
            <div id="modalBody"></div>
            <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 24px;">
                <button class="btn btn-text" onclick="closeModal()">Close</button>
                <button class="btn btn-p" id="modalConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <nav>
        <div style="padding: 16px; margin-bottom: 20px;">
            <h2 style="margin: 0; color: var(--m3-p);">XperiVerdict</h2>
            <div style="font-size: 0.7rem; font-weight: 800; opacity: 0.5;">COMMUNITY ADMIN CONSOLE</div>
        </div>
        <button class="nav-btn active" onclick="switchTab('tabStructure')"><span class="material-symbols-rounded">database</span> Hierarchy</button>
        <button class="nav-btn" onclick="switchTab('tabHistory')"><span class="material-symbols-rounded">history</span> Firmware Vault</button>
    </nav>

    <main>
        <section id="tabStructure" class="section active">
            <h1>Hardware</h1>
            <div class="admin-card srch">
                <div class="search-container">
                    <span class="material-symbols-rounded">search</span>
                    <input type="text" placeholder="Filter version..." id="deviceSearchInput">
                </div>
                <button class="btn btn-p" onclick="openDeviceModal()"><span class="material-symbols-rounded">add</span> New Series</button>
            </div>
            <div id="hierarchyControls"></div>
        </section>

        <section id="tabHistory" class="section">
            <h1>Firmware Vault</h1>
            <div class="admin-card">
                <input type="text" id="historySearch" placeholder="Search builds..." oninput="renderMasterHistory()" style="margin-bottom: 20px;">
                <table id="masterHistoryTable">
                    <thead>
                        <tr><th>Device</th><th>Build</th><th>Type</th><th>Android</th><th>Date</th></tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </section>

        <div id="pageLogin" class="page page-hidden">
            <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;">
                <div style="width: 80px; height: 80px; background: var(--m3-p-c); border-radius: 24px; display: grid; place-items: center; margin-bottom: 24px;">
                    <span class="material-symbols-rounded" style="font-size: 40px; color: var(--m3-p);">cloud</span>
                </div>
                <h1 id="authTitle">XperiVerdict</h1>
                <div class="m3-card" style="width: 100%; max-width: 320px; box-sizing: border-box;">
                    <input type="email" id="loginEmail" placeholder="Email" style="width:100%; padding:14px; border-radius:12px; border:1px solid var(--m3-out-var); margin-bottom:12px; box-sizing:border-box;">
                    <input type="password" id="loginPass" placeholder="Password" style="width:100%; padding:14px; border-radius:12px; border:1px solid var(--m3-out-var); margin-bottom:20px; box-sizing:border-box;">
                    
                    <div style="text-align: right; margin: -8px 0 16px 0;">
                        <button type="button" style="background:none; border:none; color:var(--m3-p); font-size:0.8rem; cursor:pointer; font-weight:500;" onclick="handleForgotPassword()">
                            Forgot password?
                        </button>
                    </div>

                    <button id="mainAuthBtn" class="m3-btn" onclick="handleLogin()">Sign In</button>
                    
                    <div style="margin-top: 16px; text-align: center;">
                        <button id="toggleAuthBtn" style="background:none; border:none; color:var(--m3-p); font-weight:600; cursor:pointer;" onclick="toggleAuthMode()">Create an account</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0q57Bv_I4uuRn7cig64DPKa2oviyGHdw",
            authDomain: "xperia-tracker.firebaseapp.com",
            databaseURL: "https://xperia-tracker-default-rtdb.firebaseio.com",
            projectId: "xperia-tracker",
            appId: "1:1028462018440:web:54a8a9d6ae759f2644043d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentData = {};

        window.switchTab = (id) => {
            document.querySelectorAll('.section, .nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        };

        const modal = document.getElementById('modalOverlay');
        window.openModal = (title, html, onConfirm, showConfirm = true) => {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = html;
            modal.style.display = 'grid';
            const cBtn = document.getElementById('modalConfirmBtn');
            cBtn.style.display = showConfirm ? 'inline-flex' : 'none';
            if(onConfirm) cBtn.onclick = () => { onConfirm(); closeModal(); };
        };
        window.closeModal = () => modal.style.display = 'none';

        onValue(ref(db, '/'), snap => {
            currentData = snap.val() || {};
            renderHierarchy();
            initialrenderMasterHistory();
        });

        // --- DEVICE MODAL (MODIFIED) ---
        window.openDeviceModal = (dIdx = null) => {
            if (!auth.currentUser){
               handleLoginRedirect();
               return;
            }

            const isEdit = dIdx !== null;
            const dev = isEdit ? currentData.devices[dIdx] : { name: '', desc: '' };
            
            const html = `
                <div class="m3-field"><label>Series Name</label><input type="text" id="in_devName" value="${dev.name}" placeholder="Xperia 1 VI"></div>
                <div class="m3-field"><label>Series Description</label><textarea id="in_devDesc" placeholder="Legacy flagship series...">${dev.desc || ''}</textarea></div>
            `;
            
            openModal(isEdit ? "Edit Series" : "New Series", html, () => {
                const name = document.getElementById('in_devName').value;
                const desc = document.getElementById('in_devDesc').value;
                if(!name) return;
                
                if(isEdit) {
                    update(ref(db, `devices/${dIdx}`), { name, desc });
                } else {
                    const list = currentData.devices || [];
                    list.push({ name, desc, variants: [] });
                    const user = auth.currentUser;
                    set(ref(db, 'devices'), list);
                }
            });
        };

        window.handleLoginRedirect = () => {
            document.querySelector(".pageLogin")?.classList.add("page-hidden");
            nav('pageLogin');
        }

        window.nav = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.add('page-hidden'));
            document.getElementById(id).classList.remove('page-hidden');
        };

        // --- FIRMWARE MODAL (MODIFIED) ---
        window.openFwModal = (dIdx, vIdx) => {
            if (!auth.currentUser){
               handleLoginRedirect();
               return;
            }

            const html = `
                <div class="m3-field"><label>Build Number</label><input type="text" id="in_fVer"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div class="m3-field"><label>Android Version</label><input type="text" id="in_fAnd" value="15"></div>
                    <div class="m3-field"><label>Update Type</label>
                        <select id="in_fType">
                            <option value="security">Security Patch</option>
                            <option value="os">OS Upgrade</option>
                        </select>
                    </div>
                </div>
                <div class="m3-field"><label>Changelog / Notes</label><textarea id="in_fLog" placeholder="Optimized thermals, updated security string..."></textarea></div>
            `;
            
            openModal("Add Firmware", html, () => {
                const ver = document.getElementById('in_fVer').value;
                const android = document.getElementById('in_fAnd').value;
                const type = document.getElementById('in_fType').value;
                const log = document.getElementById('in_fLog').value;
                
                const fws = currentData.devices[dIdx].variants[vIdx].firmwares || [];
                fws.unshift({ ver, android, type, log, date: new Date().toISOString().split('T')[0] });
                const user = auth.currentUser;
                set(ref(db, `devices/${dIdx}/variants/${vIdx}/firmwares`), fws);
            });
        };

        function renderHierarchy() {
            const container = document.getElementById('hierarchyControls');
            if(!currentData.devices) return;
            container.innerHTML = currentData.devices.map((dev, dIdx) => `
                <div class="admin-card device">
                    <button class="btn btn-text" style="position:absolute; right:12px; top:12px;" onclick="openDeviceModal(${dIdx})"><span class="material-symbols-rounded">edit</span></button>
                    <h2 style="margin:0">${dev.name}</h2>
                    <p style="font-size:0.85rem; color:var(--m3-out); margin: 8px 0 20px 0;">${dev.desc || 'No description provided.'}</p>
                    <div style="display:flex; justify-content:space-between; align-items:center; border-top: 1px solid #eee; padding-top:16px;">
                        <div style="display:flex; flex-wrap:wrap;">
                            ${(dev.variants || []).map((v, vIdx) => `
                                <div class="variant-chip">
                                    <div><strong>${v.model}</strong><br><small>${v.region}</small></div>
                                    <div style="display:flex; gap:4px;">
                                        <button class="btn btn-text" style="padding:4px;" onclick="openFwModal(${dIdx}, ${vIdx})"><span class="material-symbols-rounded">add_circle</span></button>
                                        <button class="btn btn-text" style="padding:4px;" onclick="viewLocalHistory(${dIdx}, ${vIdx})"><span class="material-symbols-rounded">history</span></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-text" onclick="openVariantModal(${dIdx})">+ Variant</button>
                    </div>
                </div>
            `).join('');
        }

        window.renderMasterHistory = () => {
            const body = document.getElementById('historyTableBody');
            const query = document.getElementById('historySearch').value.toLowerCase();
            let rows = [];

            (currentData.devices || []).forEach(dev => {
                (dev.variants || []).forEach(v => {
                    (v.firmwares || []).forEach(f => {
                        if(!query || `${dev.name} ${f.ver}`.toLowerCase().includes(query)) {
                            rows.push(`<tr>
                                <td><strong>${dev.name}</strong><br><small>${v.model}</small></td>
                                <td><code>${f.ver}</code></td>
                                <td><span class="type-tag tag-${f.type === 'os' ? 'os' : 'sec'}">${f.type || 'security'}</span></td>
                                <td>Android ${f.android}</td>
                                <td>${f.date}</td>
                            </tr>`);
                        }
                    });
                });
            });
            body.innerHTML = rows.join('') || "<tr><td colspan='5'>No records.</td></tr>";
        }

        window.initialrenderMasterHistory = () => {
            const body = document.getElementById('historyTableBody');
            let rows = [];
            
            (currentData.devices || []).forEach(dev => {
                (dev.variants || []).forEach(v => {
                    (v.firmwares || []).forEach(f => {
                        rows.push(`<tr>
                                <td><strong>${dev.name}</strong><br><small>${v.model}</small></td>
                                <td><code>${f.ver}</code></td>
                                <td><span class="type-tag tag-${f.type === 'os' ? 'os' : 'sec'}">${f.type || 'security'}</span></td>
                                <td>Android ${f.android}</td>
                                <td>${f.date}</td>
                            </tr>`);
                    });
                });
            });
            body.innerHTML = rows.join('') || "<tr><td colspan='5'>No records.</td></tr>";
        }

        window.viewLocalHistory = (dIdx, vIdx) => {
            const variant = currentData.devices[dIdx].variants[vIdx];
            const history = variant.firmwares || [];
            const html = history.map(f => `
                <div class="history-item">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${f.ver} <span class="type-tag tag-${f.type === 'os' ? 'os' : 'sec'}">${f.type || 'sec'}</span></strong>
                        <small>${f.date}</small>
                    </div>
                    <div style="margin-top:8px; font-size:0.85rem; color:#444; white-space:pre-wrap;">${f.log || 'No changelog provided.'}</div>
                </div>
            `).join('') || "No history.";
            openModal(`${variant.model} Logs`, html, null, false);
        };

        // ... Keep existing OpenVariantModal, renderModeration, censorComment, deleteComment from previous version ...
        window.openVariantModal = (dIdx) => {
            if (!auth.currentUser){
               handleLoginRedirect();
               return;
            }

            openModal("Add Variant", `<div class="m3-field"><label>Model</label><input type="text" id="in_vModel" placeholder="XQ-EC54"></div><div class="m3-field"><label>Region</label><input type="text" id="in_vReg" placeholder="Europe"></div>`, () => {
                const model = document.getElementById('in_vModel').value;
                const region = document.getElementById('in_vReg').value;
                const variants = currentData.devices[dIdx].variants || [];
                variants.push({ model, region, lockStatus: "Unlocked", firmwares: [] });
                set(ref(db, `devices/${dIdx}/variants`), variants);
            });
        };
        const input = document.getElementById("deviceSearchInput");
        
        input.addEventListener("input", () => {
                const query = input.value.trim().toLowerCase();

                document.querySelectorAll(".admin-card.device").forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(query) ? "" : "none";
                });
        });

        window.censorComment = (fwKey, entryId) => update(ref(db, `feedback/${fwKey}/${entryId}`), { comment: "[REDACTED]" });

        window.handleLogin = () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;

            if (!email || !pass) {
                alert("Please fill in all fields");
                return;
            }

            signInWithEmailAndPassword(auth, email, pass)
                .then(() => {
                    location.reload();
                })
                .catch(err => alert("Login Failed: " + err.message));
        };

        window.handleForgotPassword = () => {
            const email = document.getElementById('loginEmail').value;

            if (!email) {
                alert("Please enter your email address first so we can send a reset link.");
                return;
            }

            sendPasswordResetEmail(auth, email)
                .then(() => {
                    alert("Password reset email sent! Check your inbox (and spam folder).");
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;

                    if (errorCode === 'auth/user-not-found') {
                        alert("No account found with this email.");
                    } else {
                        alert("Error: " + errorMessage);
                    }
                });
        };

        window.handleRegister = () => {
    const email = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPass').value;

    if (pass.length < 6) {
        alert("Password should be at least 6 characters.");
        return;
    }

    createUserWithEmailAndPassword(auth, email, pass)
        .then((userCredential) => {
            console.log("Registered:", userCredential.user);
            // onAuthStateChanged will automatically handle the nav to pageDevices
            location.reload();
        })
        .catch((error) => {
            alert("Registration Error: " + error.message);
        });
};

        let isRegisterMode = false;

window.toggleAuthMode = () => {
    isRegisterMode = !isRegisterMode;
    const title = document.getElementById('authTitle');
    const mainBtn = document.getElementById('mainAuthBtn');
    const toggleBtn = document.getElementById('toggleAuthBtn');

    if (isRegisterMode) {
        title.innerText = "Join XperiVerdict";
        mainBtn.innerText = "Create Account";
        mainBtn.onclick = window.handleRegister;
        toggleBtn.innerText = "Already have an account? Sign In";
    } else {
        title.innerText = "XperiVerdict";
        mainBtn.innerText = "Sign In";
        mainBtn.onclick = window.handleLogin;
        toggleBtn.innerText = "Create an account";
    }
};
    </script>
</body>
</html>