<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Account Settings - Xperia Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        :root {
            --m3-p: #6750a4; --m3-on-p: #ffffff; --m3-p-c: #eaddff;
            --m3-surf: #f6f2f7; --m3-out: #79747e; --m3-error: #ba1a1a;
        }
        body { background: var(--m3-surf); font-family: 'Google Sans', sans-serif; margin: 0; padding: 20px; color: #1d1b20; }
        
        .header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .back-btn { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; }
        
        .section-title { font-size: 0.85rem; font-weight: 700; color: var(--m3-p); text-transform: uppercase; margin: 24px 0 12px 4px; letter-spacing: 0.5px; }
        
        .settings-card { background: white; border-radius: 24px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 16px; }
        
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 0.8rem; margin-bottom: 6px; color: var(--m3-out); padding-left: 4px; }
        input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #c4c7c5; box-sizing: border-box; font-family: inherit; }

        .m3-btn { background: var(--m3-p); color: white; border: none; padding: 14px 24px; border-radius: 16px; font-weight: 600; width: 100%; cursor: pointer; margin-top: 8px; transition: opacity 0.2s; }
        .m3-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .comment-item { padding: 12px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .comment-item:last-child { border-bottom: none; }
        .comment-ver { font-weight: 700; font-size: 0.9rem; }
        .comment-score { color: #FFB300; font-size: 0.8rem; }
        
        .danger-zone { border: 1px solid rgba(186, 26, 26, 0.2); background: #fffbfa; }
    </style>
</head>
<body>

    <div class="header">
        <button class="back-btn" onclick="window.location.href='index.html'">
            <span class="material-symbols-rounded">arrow_back</span>
        </button>
        <h1 style="font-size: 1.5rem; margin: 0;">Settings</h1>
    </div>

    <div class="section-title">Personal Info</div>
    <div class="settings-card">
        <div class="input-group">
            <label>Display Name</label>
            <input type="text" id="newName" placeholder="Enter your name">
        </div>
        <button class="m3-btn" id="saveNameBtn" onclick="updateDisplayName()">Update Name</button>
    </div>

    <div class="section-title">Your Verdicts</div>
    <div class="settings-card" id="myCommentsList">
        <p style="color: var(--m3-out); font-size: 0.9rem; text-align: center;">Loading your history...</p>
    </div>

    <div class="section-title" style="color: var(--m3-error);">Danger Zone</div>
    <div class="settings-card danger-zone">
        <p style="font-size: 0.85rem; color: var(--m3-out); margin-top: 0;">Deleting your account is permanent. All your ratings will be lost.</p>
        <button class="m3-btn" style="background: var(--m3-error);" onclick="deleteUserAccount()">Delete Account</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, deleteUser } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        // --- Use your same config here ---
        const firebaseConfig = {
            apiKey: "AIzaSyA0q57Bv_I4uuRn7cig64DPKa2oviyGHdw",
            authDomain: "xperia-tracker.firebaseapp.com",
            databaseURL: "https://xperia-tracker-default-rtdb.firebaseio.com",
            projectId: "xperia-tracker",
            appId: "1:1028462018440:web:54a8a9d6ae759f2644043d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('newName').value = user.displayName || "";
                loadUserComments(user.uid);
            } else {
                window.location.href = 'index.html'; // Redirect if logged out
            }
        });

        // 1. CHANGE NAME
        window.updateDisplayName = () => {
            const name = document.getElementById('newName').value;
            const btn = document.getElementById('saveNameBtn');
            btn.disabled = true;
            btn.innerText = "Saving...";

            updateProfile(auth.currentUser, { displayName: name })
                .then(() => {
                    alert("Profile updated!");
                    btn.disabled = false;
                    btn.innerText = "Update Name";
                })
                .catch(e => alert(e.message));
        };

        // 2. VIEW ALL MY COMMENTS (Verdicts)
        function loadUserComments(uid) {
            onValue(ref(db, 'ratings'), snap => {
                const allFws = snap.val() || {};
                let html = "";
                let count = 0;

                for (let fwKey in allFws) {
                    const fwRatings = allFws[fwKey]; // This is now a collection of unique keys
                    
                    for (let ratingId in fwRatings) {
                        const rating = fwRatings[ratingId];
                        
                        if (rating.uid === uid) {
                            count++;
                            const version = fwKey.replace(/_/g, '.');
                            html += `
                                <div class="comment-item">
                                    <div>
                                        <div class="comment-ver">Firmware ${version}</div>
                                        <div class="comment-score">${'â˜…'.repeat(rating.score)}</div>
                                    </div>
                                    <button onclick="deleteVerdict('${fwKey}', '${ratingId}')" ...>
                                        <span class="material-symbols-rounded">delete</span>
                                    </button>
                                </div>
                            `;
                        }
                    }
                }
                document.getElementById('myCommentsList').innerHTML = count > 0 ? html : "<p>No verdicts yet.</p>";
            });
        }

        // 3. DELETE SPECIFIC VERDICT
        window.deleteVerdict = (fwKey) => {
            if (confirm("Remove this verdict?")) {
                remove(ref(db, `ratings/${fwKey}/${auth.currentUser.uid}`))
                    .then(() => alert("Verdict removed."));
            }
        };

        // 4. DELETE ACCOUNT
        window.deleteUserAccount = () => {
            if (confirm("Are you absolutely sure? This cannot be undone.")) {
                const user = auth.currentUser;
                deleteUser(user)
                    .then(() => {
                        alert("Account deleted.");
                        window.location.href = 'index.html';
                    })
                    .catch(e => {
                        if (e.code === 'auth/requires-recent-login') {
                            alert("For security, please log out and log back in before deleting your account.");
                        } else {
                            alert(e.message);
                        }
                    });
            }
        };
    </script>
</body>
</html>